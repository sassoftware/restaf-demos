var e=require("openai"),t=require("@azure/openai"),n=require("@sassoftware/restaf"),r=require("@sassoftware/restaflib");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=/*#__PURE__*/o(e),i=/*#__PURE__*/o(n),a=/*#__PURE__*/o(r),u=function(e,t,n,r){try{var o=function(){function t(){return{thread:s,assistant:n}}var r=function(){if(null==s)return console.log("Creating new thread"),Promise.resolve(e.beta.threads.create({metadata:{assistanceName:n.name}})).then(function(t){return s=t,Promise.resolve(e.beta.assistants.update(n.id,{metadata:{thread_id:s.id,lastRunId:"0"}})).then(function(e){n=e})})}();return r&&r.then?r.then(t):t()},s=null,i=function(){if(!0===r&&"0"!=t){var n=function(n,r){try{var o=Promise.resolve(e.beta.threads.retrieve(t)).then(function(e){s=e})}catch(e){return r(e)}return o&&o.then?o.then(void 0,r):o}(0,function(e){console.log(e),console.log(e.status),console.log("Error status "+e.status+". Unable to retrieve the thread "+thread_id)});if(n&&n.then)return n.then(function(){})}}();return Promise.resolve(i&&i.then?i.then(o):o())}catch(e){return Promise.reject(e)}},c=function(e,t,n){try{return Promise.resolve(e.beta.threads.messages.list(t.id,{limit:n})).then(function(e){var t=e.data[0].content[0];return t[t.type].value})}catch(e){return Promise.reject(e)}};function l(e,t,n){if(!e.s){if(n instanceof d){if(!n.s)return void(n.o=l.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(l.bind(null,e,t),l.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var h=function(e,t,n){try{var r=function(){return Promise.resolve(o.beta.assistants.update(s.id,{metadata:{thread_id:e.id,lastRunId:t.id}})).then(function(e){return n.assistant=e,a})},o=n.openai,s=n.assistant,i=null,a=null,u=function(e,t){var n;do{var r=e();if(r&&r.then){if(!f(r)){n=!0;break}r=r.v}var o=t();if(f(o)&&(o=o.v),!o)return r}while(!o.then);var s=new d,i=l.bind(null,s,2);return(n?r.then(a):o.then(u)).then(void 0,i),s;function a(n){for(r=n;f(o=t())&&(o=o.v),o;){if(o.then)return void o.then(u).then(void 0,i);if((r=e())&&r.then){if(!f(r))return void r.then(a).then(void 0,i);r=r.v}}l(s,1,r)}function u(n){if(n){do{if((r=e())&&r.then){if(!f(r))return void r.then(a).then(void 0,i);r=r.v}if(f(n=t())&&(n=n.v),!n)return void l(s,1,r)}while(!n.then);n.then(u).then(void 0,i)}else l(s,1,r)}}(function(){return Promise.resolve(o.beta.threads.runs.retrieve(e.id,t.id)).then(function(e){a=e,console.log("-------------------",a.status);var t=function(){if("queued"===a.status||"in_progress"===a.status||"cancelling"===a.status)return Promise.resolve(new Promise(function(e){return setTimeout(e,2e3)})).then(function(){});i=a.status}();if(t&&t.then)return t.then(function(){})})},function(){return null===i});return Promise.resolve(u&&u.then?u.then(r):r())}catch(e){return Promise.reject(e)}};const d=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{l(r,1,e(this.v))}catch(e){l(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?l(r,1,t?t(o):o):n?l(r,1,n(o)):l(r,2,o)}catch(e){l(r,2,e)}},r},e}();function f(e){return e instanceof d&&1&e.s}var v="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function m(e,t,n){if(!e.s){if(n instanceof p){if(!n.s)return void(n.o=m.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(m.bind(null,e,t),m.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var p=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var s=1&o?t:n;if(s){try{m(r,1,s(this.v))}catch(e){m(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?m(r,1,t?t(o):o):n?m(r,1,n(o)):m(r,2,o)}catch(e){m(r,2,e)}},r},e}();function P(e){return e instanceof p&&1&e.s}function y(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}exports.closeAssistant=function(e,t){return Promise.resolve(!0)},exports.runAssistant=function(e,t,n){try{var r=function(){return Promise.resolve(o.beta.threads.messages.create(i.id,{role:"user",content:e})).then(function(e){return Promise.resolve(o.beta.threads.runs.create(i.id,{assistant_id:s.id,instructions:"Help user use SAS Viya to accomplish a task\n                      Allow users to query for information from a Viya Server.\n                      Allow users to query the retrieved information"})).then(function(e){return a=e,Promise.resolve(h(i,a,t)).then(function(e){return"completed"===e.status?Promise.resolve(c(o,i,1)):"requires_action"===e.status?Promise.resolve(function(e,t,n,r,o){try{var s=function(){return Promise.resolve(i.beta.threads.runs.submitToolOutputs(t.id,n.id,{tool_outputs:u})).then(function(e){return Promise.resolve(h(t,e,r))})},i=r.openai,a=r.specs.functionList,u=[],c=function(e,t,n){if("function"==typeof e[v]){var r,o,s,i=e[v]();if(function e(n){try{for(;!(r=i.next()).done;)if((n=t(r.value))&&n.then){if(!P(n))return void n.then(e,s||(s=m.bind(null,o=new p,2)));n=n.v}o?m(o,1,n):o=n}catch(e){m(o||(o=new p),2,e)}}(),i.return){var a=function(e){try{r.done||i.return()}catch(e){}return e};if(o&&o.then)return o.then(a,function(e){throw a(e)});a()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<e.length;c++)u.push(e[c]);return function(e,t,n){var r,o,s=-1;return function n(i){try{for(;++s<e.length;)if((i=t(s))&&i.then){if(!P(i))return void i.then(n,o||(o=m.bind(null,r=new p,2)));i=i.v}r?m(r,1,i):r=i}catch(e){m(r||(r=new p),2,e)}}(),r}(u,function(e){return t(u[e])})}(e.required_action.submit_tool_outputs.tool_calls,function(e){var t=e.function.name;console.log("Requested function: ",t);var n=JSON.parse(e.function.arguments);return Promise.resolve(a[t](n,o,r)).then(function(t){u.push({tool_call_id:e.id,output:JSON.stringify(t)})})});return Promise.resolve(c&&c.then?c.then(s):s())}catch(e){return Promise.reject(e)}}(e,i,a,t,n)).then(function(e){return Promise.resolve(c(o,i,1))}):{runStatus:e.status}})})})},o=t.openai,s=t.assistant,i=t.thread,a=null,u=y(function(){return Promise.resolve(o.beta.threads.messages.create(i.id,{role:"user",content:e})).then(function(e){})},function(e){console.log("status = "+e.status+". Unable to add the prompt to the thread"),console.log("will try to cancel the last run"),console.log(e);var n=function(){if(400!==e.status||"0"===s.metadata.lastRunId)return Promise.resolve(o.beta.threads.del(i.id)).then(function(){return Promise.resolve(o.beta.threads.create({metadata:{assistanceName:s.name,lastRunId:"0"}})).then(function(e){t.thread=i=e,console.log("Deleted old thread and created a new one")})});var n=y(function(){return Promise.resolve(o.beta.threads.runs.cancel(i.id,s.metadata.lastRunId)).then(function(e){return a=e,Promise.resolve(o.beta.assistants.update(s.id,{metadata:{thread_id:i.id,lastRunId:a.id}})).then(function(e){t.assistant=s=e,console.log("Cancelled the last run")})})},function(e){console.log("Unable to cancel the last run"),console.log(e)});return n&&n.then?n.then(function(){}):void 0}();return n&&n.then?n.then(function(){}):void 0});return Promise.resolve(u&&u.then?u.then(r):r())}catch(e){return Promise.reject(e)}},exports.setupAssistant=function(e){try{var n=e.provider,r=e.assistantName,o=e.credentials,c="openai"===n?o.openaiKey:o.azureaiKey,l=o.azureaiEndpoint,h="openai"===n?new s.default({apiKey:c}):new t.OpenAIClient(l,new t.OpenAIKeyCredential(c));return Promise.resolve(h.beta.assistants.list({order:"desc",limit:"100"})).then(function(t){var n=t.data.find(function(e){if(e.name===r)return e});return Promise.resolve(null==n?function(e,t){try{var n=t.assistantName,r=t.specs,o=t.reuseThread;return Promise.resolve(e.beta.assistants.create({name:n,instructions:t.instructions,model:t.model,tools:r.tools,metadata:{thread_id:"0",lastRunId:"0"}})).then(function(s){return console.log("-----------------------------------"),console.log("New Assistant: ",n,s.id),Promise.resolve(u(e,t.threadid,s,o)).then(function(t){return console.log("Thread ID: ",t.thread.id),console.log("-----------------------------------"),{openai:e,assistant:t.assistant,thread:t.thread,threadid:t.thread.id,specs:r}})})}catch(e){return Promise.reject(e)}}(h,e):function(e,t,n){try{var r=n.reuseThread;console.log("Using Existing Assistant: ",t.name,t.id);var o=t.metadata.thread_id;return"0"!==n.threadid&&(o=n.threadid),console.log("Associated thread_id: ",o),Promise.resolve(u(e,o,t,r)).then(function(t){return{openai:e,assistant:t.assistant,thread:t.thread,threadid:t.thread.id,specs:n.specs}})}catch(e){return Promise.reject(e)}}(h,n,e)).then(function(t){return Promise.resolve(function(e,t){try{var n={host:null,logonPayload:null,store:null,session:null,servers:null,casServerName:null,source:e,sessionID:null};if("none"===e||null==e)return Promise.resolve(n);var r=i.default.initStore({casProxy:!0});return Promise.resolve(r.logon(t)).then(function(){function o(){return Promise.resolve(r.apiCall(n.session.links("self"))).then(function(e){return n.sessionID=e.items("id"),n})}n={host:host,logonPayload:t,store:r,source:e};var s="cas"===e?Promise.resolve(a.default.casSetup(r,null)).then(function(e){var t=e.session,r=e.servers;n.session=t,n.servers=r,n.casServerName=t.links("execute","link","server")}):Promise.resolve(a.default.computeSetup(r)).then(function(e){n.session=e,n.server=null});return s&&s.then?s.then(o):o()})}catch(e){return Promise.reject(e)}}(e.source)).then(function(e){return{gptControl:t,appEnv:e}})})})}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=index.cjs.map
