{"version":3,"file":"index.module.js","sources":["../src/loadThread.js","../src/setupAssistant.js","../src/createAssistant.js","../src/getLatestMessage.js","../src/pollRun.js","../src/required_action.js","../src/runAssistant.js","../src/closeAssistant.js","../src/getMessages.js"],"sourcesContent":["/*\r\n * Copyright © 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @async\r\n * @function loadThread\r\n * @description   new thread or open existing thread\r\n * @params {object} client - client object\r\n * @param {object} config - configuration object\r\n * @returns {promise} - return thread object\r\n */\r\nasync function loadThread(client, config) {\r\n  let {threadid} = config; \r\n  let thread = null;\r\n  // If we are reusing the thread, try to retrieve it\r\n  try {\r\n    thread = (threadid === '0') \r\n      ? await client.beta.threads.create({ metadata: { assistantName: assistant.name }})\r\n      : await client.beta.threads.retrieve(threadid);\r\n  } catch (error) {\r\n    console.log(error); \r\n    console.log(error.status);\r\n    throw new Error(`Error status ${error.status}. Unable to retrieve the thread ${threadid}. see console for details.`);\r\n  }\r\n  debugger;\r\n  return thread;\r\n}\r\nexport default loadThread;\r\n","/*\r\n * Copyright © 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @async\r\n * @function setupAssistant\r\n * @description   Setup the GPT Assistant\r\n * @param {object} config - configuration object\r\n * @returns {promise} - return gptControl object}\r\n */\r\nimport OpenAI from 'openai';\r\nimport { OpenAIClient, OpenAIKeyCredential } from '@azure/openai';\r\nimport loadThread from './loadThread.js';\r\nimport createAssistant from './createAssistant.js';\r\n\r\nasync function setupAssistant(config) {\r\n  let { provider, credentials } = config;\r\n  let {openaiKey, azureaiKey, azureaiEndpoint} = credentials;\r\n  // let apiKey = (provider === 'openai') ? process.env.OPENAI_KEY : process.env.OPENAI_AZ_KEY;\r\n\r\n  //\r\n  debugger;\r\n  let client = null;\r\n  if (provider === 'openai') {\r\n    if (openaiKey == null) {\r\n      throw new Error('Missing OpenAI API Key');\r\n    }\r\n    client = new OpenAI({ apiKey: openaiKey, dangerouslyAllowBrowser: true });\r\n\r\n  } else if (provider === 'azureai') {\r\n    if (azureaiKey == null) {\r\n      throw new Error('Missing Azure API Key');\r\n    }\r\n    if (azureaiEndpoint == null) {\r\n      throw new Error('Missing Azure Endpoint');\r\n    }\r\n    client = new OpenAIClient(endpoint, new OpenAIKeyCredential(azureaiKey));\r\n    debugger;\r\n    console.log(Object.keys(client));\r\n  } else {\r\n    throw new Error('Invalid provider. Must be openai or azureai.');\r\n  }\r\n\r\n  debugger;\r\n  let gptControl = {\r\n    client: client,\r\n    assistant: null,\r\n    thread: null,\r\n    threadid: null,\r\n    specs: config.domainTools,\r\n    appEnv: null,\r\n    config: config, // save the config for runtime changes\r\n  };\r\n  // create assistant and thread\r\n  debugger;\r\n  gptControl.assistant = await createAssistant(client, config);\r\n  debugger;\r\n  gptControl.thread = await loadThread(client, config);\r\n  debugger;\r\n  gptControl.threadid = gptControl.thread.id;// just for convenience\r\n  return gptControl;\r\n}\r\nexport default setupAssistant;\r\n","/*\r\n * Copyright © 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\n/**\r\n * @async\r\n * @function createAssistant\r\n * @description   Create a new assistant\r\n * @param {string} client - client object\r\n * @param {object} config - configuration object\r\n * @returns {promise} - return assistant object\r\n */\r\nasync function createAssistant(client, config) {\r\n  let { assistantName, assistantid, instructions, model, domainTools } = config;\r\n\r\n  // create args for assistant create\r\n  let createArgs = {\r\n    name: assistantName,\r\n    instructions: instructions,\r\n    model: model,\r\n  };\r\n  if (domainTools.tools != null) {\r\n    createArgs.tools = domainTools.tools;\r\n  }\r\n\r\n  let assistant = null;\r\n  debugger;\r\n  console.log(assistantid);\r\n  if (assistantid !== \"0\") {\r\n    debugger;\r\n    assistant = await client.beta.assistants.retrieve(assistantid);\r\n    debugger;\r\n  } else {\r\n    // local rules: avoid creating a new assistant if one exists\r\n    // use name to find the assistant\r\n    // wish there was a way to filter on names in the API call\r\n    debugger;\r\n    const myAssistants = await client.beta.assistants.list({\r\n      order: \"desc\",\r\n      limit: \"100\", //ugh!\r\n    });\r\n    assistant = myAssistants.data.find((a) => {\r\n      if (a.name === assistantName) {\r\n        return a;\r\n      }\r\n    });\r\n    // if first time using this name, create the assistant\r\n    if (assistant == null) {\r\n      assistant = await client.beta.assistants.create(createArgs);\r\n    }\r\n  }\r\n  \r\n  debugger;\r\n  return assistant;\r\n}\r\nexport default createAssistant;\r\n","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @async\r\n * @description Return the latest message from thread\r\n * @param {object}  gptControl- client control object\r\n * @param {number} limit - limit the number of messages to return\r\n * @returns {promise} - messages - array of latest assistant messages[ {id, role, type, content}]\r\n * @notes - This function will return latest assistant messages based on limit\r\n */\r\nasync function getLatestMessage(gptControl, limit) {  \r\n  let {client, thread} = gptControl;\r\n  const messages = await client.beta.threads.messages.list(thread.id, {limit:limit});\r\n  //console.log('body', JSON.stringify(messages.body.data, null, 4));\r\n  let output = [];\r\n  let data = messages.data;\r\n  for (let i = 0; i < messages.data.length; i++){\r\n    let content = data[i].content[0];\r\n    if (data[i].role === 'assistant') {\r\n      output.push({id: data[i].id, role: data[i].role, type: content.type, content: content[content.type].value});\r\n    } else {\r\n      break;\r\n    }\r\n  }\r\n  if (output.length > 1) {\r\n    output = output.reverse();\r\n  }\r\n  return output;\r\n\r\n}\r\nexport default getLatestMessage;","\r\n/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\n/**\r\n * @async\r\n * @description - Poll run status since there is no streaming support\r\n * @function pollRun\r\n * @params {object} client - client object\r\n * @params {object} thread - thread object\r\n * @params {object} run - run object    \r\n * @params {object} gptControl - gpt  session control object\r\n * @returns {object} - runStatus from client.beta.threads.runs.retrieve\r\n * @notes - Will wait for completion(!(queued,in_progress, cancelling))\r\n */\r\nasync function pollRun(thread, run, gptControl) {\r\n  let { client} = gptControl;\r\n  let done = null;\r\n  let runStatus = null;\r\n  function sleep(ms) {\r\n    return new Promise((resolve) => setTimeout(resolve, ms));\r\n  }\r\n  // Since there is no streaming support, sleep and poll the status\r\n  do {\r\n    debugger;\r\n    runStatus = await client.beta.threads.runs.retrieve(thread.id, run.id);\r\n    \r\n    console.log(\"-------------------\", runStatus.status);\r\n    if (\r\n      !(\r\n        runStatus.status === \"queued\" ||\r\n        runStatus.status === \"in_progress\" ||\r\n        runStatus.status === \"cancelling\"\r\n      )\r\n    ) {\r\n      debugger;\r\n      done = runStatus.status;\r\n    } else {\r\n      await sleep(2000);\r\n      console.log(\"waited 2000 ms\");\r\n    }\r\n  } while (done === null);\r\n\r\n  /*\r\n  let newAssistant = await client.beta.assistants.update(assistant.id, {\r\n    metadata: { thread_id: thread.id, lastRunId: run.id} \r\n  });\r\n  */\r\n  debugger;\r\n //  gptControl.assistant = newAssistant;\r\n  return runStatus;\r\n\r\n}\r\nexport default pollRun;","\r\n/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\n/**\r\n * @async\r\n * @description - Handle required actions for Assistant\r\n * @function required_action\r\n * @param {object} runStatus - run status object\r\n * @param {object} thread - thread object\r\n * @param {object} run - run object\r\n * @param {object} gptControl - gpt  session control object\r\n * @param {object} appEnv - Viya session control object(has store, sessionID, etc. to talk to Viya server)\r\n * @returns {promise} - status from submitToolOutputs\r\n */\r\nimport pollRun from \"./pollRun.js\";\r\nasync function required_action(runStatus, thread, run,  gptControl, appEnv) {\r\n  let{client,specs} = gptControl;\r\n  let {functionList} = specs;\r\n  \r\n  // get the required actions from the run status\r\n  let requiredActions = runStatus.required_action.submit_tool_outputs.tool_calls;\r\n  \r\n  let toolsOutput = [];\r\n  for (let action of requiredActions) {\r\n    let functionName = action.function.name;\r\n    console.log('Requested function: ', functionName);\r\n    let params = JSON.parse(action.function.arguments);\r\n    debugger;\r\n    let response = await functionList[functionName](params, appEnv, gptControl);\r\n    debugger;\r\n    toolsOutput.push({\r\n      tool_call_id: action.id,\r\n      output: JSON.stringify(response),\r\n    });\r\n }\r\n// submit the outputs to the thread\r\n let newRun = await client.beta.threads.runs.submitToolOutputs(\r\n  thread.id, run.id, { tool_outputs: toolsOutput });\r\n\r\n// wait for output to appear in the thread messages\r\n let outputStatus = await pollRun(thread, newRun, gptControl);\r\n\r\nreturn outputStatus;\r\n}\r\nexport default required_action;","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\nimport getLatestMessage from \"./getLatestMessage.js\";\r\nimport required_action from \"./required_action.js\";\r\nimport pollRun from \"./pollRun.js\";\r\n\r\n/**\r\n * @async\r\n * @description - Run the latest prompt from the user\r\n * @function runAssistant\r\n *\r\n * @param {object} gptControl - gpt  session control object\r\n * @param {string} prompt - user's prompt\r\n * @param {string} instructions - Additional instructions for the run\r\n * @param {object} appEnv - application info - ex: Viya session control object(has store, sessionID, etc. to talk to Viya server)\r\n \r\n * @returns {promise} - response from GPT(can be text, string, html etc...)\r\n * @notes - This function will run the assistant with the prompt and return the response from the assistant.\r\n * @example \r\n *  let response = await runAssistant(gptControl, prompt, promptInstructions,appEnv); \r\n*/\r\n\r\nasync function runAssistant(gptControl,prompt, instructions, appEnv) {\r\n  let { client, assistant, thread, specs } = gptControl;\r\n  //add the user request to thread\r\n  try {\r\n    let _newMessage = await client.beta.threads.messages.create(thread.id, {\r\n      role: \"user\",\r\n      content: prompt,\r\n    });\r\n    let r = await runPrompt(gptControl, appEnv, instructions);\r\n    return r;\r\n  } catch (error) {\r\n    //tbd: recovery?\r\n    debugger;\r\n    console.log(\r\n      `status = ${error.status}. Unable to add the prompt to the thread`\r\n    );\r\n    console.log(error);\r\n    throw new Error('Unable to add the prompt to the thread. See console for more details');\r\n  }\r\n}\r\nasync function runPrompt(gptControl, appEnv, instructions) {\r\n  let { client, assistant, thread } = gptControl;\r\n  let runArgs = {\r\n    assistant_id: assistant.id,\r\n    instructions: instructions != null ? instructions : \"\",\r\n  };\r\n  // Run the assistant with the prompt and poll for completion\r\n  let run = await client.beta.threads.runs.create(thread.id, runArgs);\r\n  debugger;\r\n  let runStatus = await pollRun(thread, run, gptControl);\r\n\r\n  //check for completion status\r\n  let message;\r\n  if (runStatus.status === \"completed\") {\r\n    message = await getLatestMessage(gptControl, 5);\r\n  } else if (runStatus.status === \"requires_action\") {\r\n    let r = await required_action(runStatus, thread, run, gptControl, appEnv);\r\n    message = await getLatestMessage(gptControl, 5);\r\n  } else {\r\n    message = [{ runStatus: runStatus.status }];\r\n  }\r\n  return message;\r\n}\r\nexport default runAssistant;\r\n\r\n//https://platform.openai.com/docs/guides/text-generation/chat-completions-api\r\n","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @async\r\n * @description - Close Viya connections.\r\n * @function closeAssistant\r\n * @param {object} gptControl - gpt session control object\r\n * @param {object} appEnv - Viya session control object(has store, sessionID, etc. to talk to Viya server)\r\n * @returns {boolean} - true\r\n */\r\nasync function closeAssistant(_gptControl, _appEnv) {\r\n  console.log('in closeAssistant');\r\n  return true;\r\n}\r\nexport default closeAssistant;","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * \r\n * @description Return sepcified number of messages from thread\r\n * @param {object}  gptControl- client control object\r\n * @param {number} limit - limit the number of messages to return\r\n * @returns {*} - messages - array of messages[ {id, role, type, content}]\r\n * @notes - This function will return the specified number of messages from the thread\r\n * Typically the top 2 will be the assistant message and user's prompt\r\n */\r\nasync function getMessages(gptControl, limit) {  \r\n  let {client, thread} = gptControl;\r\n  const messages = await client.beta.threads.messages.list(thread.id, {limit:limit});\r\n  //console.log('body', JSON.stringify(messages.body.data, null, 4));\r\n  let output = messages.data.map((m) => {\r\n    let content = m.content[0];\r\n    return {id: m.id, role: m.role, type: content.type, content: content[content.type].value};\r\n  });\r\n  return output;\r\n\r\n}\r\nexport default getMessages;"],"names":["setupAssistant","config","provider","credentials","openaiKey","azureaiKey","azureaiEndpoint","client","Error","OpenAI","apiKey","dangerouslyAllowBrowser","OpenAIClient","endpoint","OpenAIKeyCredential","console","log","Object","keys","gptControl","assistant","thread","threadid","specs","domainTools","appEnv","Promise","resolve","_temp3","assistantName","assistantid","createArgs","name","instructions","model","tools","_temp2","beta","assistants","retrieve","then","_client$beta$assistan","list","order","limit","myAssistants","data","find","a","_temp","create","_client$beta$assistan2","e","reject","createAssistant","_createAssistant","_result","body","recover","result","threads","metadata","_client$beta$threads$","_catch","error","status","loadThread","_loadThread","id","getLatestMessage","messages","output","i","length","content","role","push","type","value","reverse","_settle","pact","state","s","_Pact","o","bind","v","observer","pollRun","run","runStatus","done","test","awaitBody","_isSettledPact","shouldContinue","_resumeAfterBody","_resumeAfterTest","_do","runs","setTimeout","prototype","onFulfilled","onRejected","this","callback","_this","thenable","_iteratorSymbol","Symbol","iterator","runAssistant","prompt","_newMessage","assistant_id","message","_getLatestMessage","submitToolOutputs","tool_outputs","toolsOutput","newRun","functionList","target","check","step","_cycle","next","return","_fixup","TypeError","values","array","_forTo","_forOf","required_action","submit_tool_outputs","tool_calls","action","functionName","params","JSON","parse","arguments","response","tool_call_id","stringify","r","_getLatestMessage2","runPrompt","closeAssistant","_gptControl","_appEnv","getMessages","map","m"],"mappings":"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"}