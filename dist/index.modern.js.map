{"version":3,"file":"index.modern.js","sources":["../src/builtins/lib/string2Table.js","../src/builtins/lib/rows2csv.js","../src/builtins/functions.js","../src/builtins/lib/logAsArray.js","../src/builtins/functionSpecs.js","../src/apiMapper.js","../src/setupAssistant.js","../src/builtins/instructions.js","../src/builtins/lib/setupViya.js","../src/createAssistant.js","../src/loadThread.js","../src/getLatestMessage.js","../src/pollRun.js","../src/required_action.js","../src/runAssistant.js","../src/deleteAssistant.js","../src/getMessages.js","../src/uploadFile.js","../src/cancelRun.js"],"sourcesContent":["/*\r\n* Copyright © 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n* SPDX-License-Identifier: Apache-2.0\r\n*/\r\n/**\r\n * \r\n * @param {string} table as a.b\r\n * @param {string} source (cas or compute)\r\n * @returns {object} - {libref: a, name: b} or null\r\n */\r\nfunction string2Table(table, source) {\r\n  let iTable = {};\r\n  let lib = (source === 'cas') ? 'caslib' : 'libref';\r\n  let parts = table.split('.');  \r\n  if (parts.length === 2) {\r\n    iTable[lib] = parts[0];\r\n    iTable.name = parts[1];\r\n    return iTable;\r\n  } else {\r\n    return null;\r\n  }\r\n}\r\nexport default string2Table;","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\nfunction rows2csv(arr) {\r\n  // Check if there's data\r\n  if (arr.length === 0) {\r\n    return '';\r\n  }\r\n\r\n  // Extract headers\r\n  let headers = Object.keys(arr[0]).join(',') + '\\n';\r\n  let rows ='';\r\n  arr.map(obj => {\r\n    let line ='';\r\n    let sep = '';\r\n    Object.values(obj).map(value => {\r\n      line = line + sep + value2String(value);\r\n      sep = ',';\r\n    });\r\n    rows = rows + line + '\\n';\r\n  })\r\n  return headers + rows;\r\n}\r\nfunction value2String (value) {\r\n  let valueString;\r\n  if (value == '.' || value == null) {\r\n    valueString = '';\r\n  } else if (typeof value === 'string') {\r\n    value = value.replace(/\"/g, '\"\"');\r\n    valueString = value.trim()\r\n  } else {\r\n    valueString = value.toString();\r\n  }\r\n  return valueString;\r\n}\r\nexport default rows2csv;\r\n\r\n","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n//import restafedit from \"@sassoftware/restafedit\";\r\n//import restaflib from \"@sassoftware/restaflib\"\r\n\r\nimport logAsArray from \"./lib/logAsArray.js\";\r\nimport string2Table from \"./lib/string2Table.js\";\r\nimport rows2csv from \"./lib/rows2csv.js\";\r\n/**\r\n * @description Function for the assistant\r\n * @private\r\n * @function functionSpecs\r\n * @returns {object} - object containing function specs \r\n * @returns {object} - a functions object({f1: function1, f2: function2, ...})\r\n * \r\n */\r\n\r\n\r\n//const fss = fs.promises;\r\n// const { caslRun, computeRun, computeResults } = restaflib;\r\n// const { getLibraryList, getTableList, getTableColumns } = restafedit;\r\n\r\nfunction functions() {\r\n  let flist = {\r\n    _getData,\r\n    _listSASObjects,\r\n    _listSASTables,\r\n    _listColumns,\r\n    _listSASDataLib,\r\n    _runSAS,\r\n    _keywords,\r\n    _describeTable,\r\n   // _contextData\r\n  };\r\n  return flist;\r\n}\r\n\r\nasync function _listSASObjects(params, appEnv) {\r\n  let { resource, limit } = params;\r\n  let store = appEnv.store;\r\n  \r\n  limit = limit == null ? 10 : limit;\r\n  if (\r\n    [\"files\", \"folders\", \"reports\"].includes(resource.toLowerCase()) === false\r\n  ) {\r\n    return `{Error: \"resource ${resource} is not supported at this time\"}`;\r\n  }\r\n  let r = await store.addServices(resource);\r\n  let s = r[resource];\r\n  let payload = {\r\n    qs: {\r\n      limit: limit,\r\n      start: 0,\r\n    },\r\n  };\r\n  let results = await store.apiCall(s.links(resource), payload);\r\n  let items = results.itemsList().toJS();\r\n  \r\n  return JSON.stringify(items);\r\n}\r\nasync function _listSASDataLib(params, appEnv) {\r\n  let { limit, source, start} = params;\r\n  let payload = {\r\n    qs: {\r\n      limit: (limit == null) ? 10 : limit,\r\n      start: (start == null) ? 0 : start\r\n    },\r\n  };\r\n  let r = await appEnv.restafedit.getLibraryList(appEnv, payload);\r\n  return JSON.stringify(r);\r\n}\r\nasync function _listSASTables(params, appEnv) {\r\n  let { library, limit } = params;\r\n  let p = {\r\n    qs: {\r\n      limit: limit == null ? 10 : limit,\r\n      start: 0,\r\n    },\r\n  };\r\n  let r = await appEnv.restafedit.getTableList(library, appEnv, p);\r\n  return JSON.stringify(r);\r\n}\r\nasync function _listColumns(params, appEnv) {\r\n  let { table } = params;\r\n  let { source } = appEnv;\r\n  \r\n  let iTable = string2Table(table, source);\r\n  if (iTable === null) {\r\n    return \"Table must be specified in the form casuser.cars or sashelp.cars\";\r\n  }\r\n\r\n  let r =  await appEnv.restafedit.getTableList(library, appEnv, p);\r\n  \r\n  return JSON.stringify(r);\r\n}\r\nasync function _getData(params, appEnv) {\r\n  let r = await _idescribeTable(params, appEnv);\r\n  return JSON.stringify({table: r.table, data: r.data});\r\n}\r\nasync function _runSAS(params, appEnv, gptControl) {\r\n  let { program } = params;\r\n  let { store, session } = appEnv;\r\n  let {caslRun, computeRun, computeResults} = appEnv.restaflib;\r\n  let src = program;//place holder\r\n  if (appEnv.source === \"cas\") {\r\n    let r = await caslRun(store, session, src, {}, true);\r\n    return JSON.stringify(r.results);\r\n  } else {\r\n    let computeSummary = await computeRun(store, session, src);\r\n    let log = await computeResults(store, computeSummary, \"log\");\r\n    return logAsArray(log);\r\n  }\r\n}\r\n\r\nasync function _keywords(params) {\r\n  let { keywords, format } = params;\r\nconsole.log('keywords', keywords, format);\r\n  switch (format) {\r\n    case \"html\": {\r\n      let t = \"<ul>\";\r\n      keywords.split(\",\").forEach((k) => {\r\n        t += `<li>${k}</li>`;\r\n      });\r\n      t += \"</ul>\";\r\n      return t;\r\n    }\r\n    case \"array\":\r\n      return keywords.split(\",\");\r\n    case \"object\": {\r\n      let r = {};\r\n      keywords.split(\",\").forEach((k, i) => {\r\n        r[`key${i}`] = k;\r\n      });\r\n      return r;\r\n    }\r\n    default:\r\n      return params;\r\n  }\r\n}\r\nasync function _describeTable(params, appEnv) {\r\n let r = await _idescribeTable(params, appEnv);\r\n return JSON.stringify(r);\r\n\r\n}\r\nasync function _idescribeTable(params, appEnv) {\r\n  //TBD: need to move most of this code to restafedit\r\n  let { table, limit, format, where, csv } = params;\r\n  let { source, sessionID, restafedit } = appEnv;\r\n  csv = csv == null ? false : csv;\r\n  let iTable = string2Table(table, source);\r\n  if (iTable === null) {\r\n    return \"Table must be specified in the form casuser.cars or sashelp.cars\";\r\n  }\r\n  // setup call to restafedit.setup\r\n  let appControl = {\r\n    source: source,\r\n    table: iTable,\r\n    casServerName: appEnv.casServerName,\r\n    computeContext: appEnv.computeContext,\r\n    initialFetch: {\r\n      qs: {\r\n        start: 0,\r\n        limit: limit == null ? 2 : limit,\r\n        format: format == null ? false : format,\r\n        where: where == null ? \"\" : where,\r\n      },\r\n    },\r\n  };\r\n\r\n  let tappEnv = await restafedit.setup(\r\n    appEnv.logonPayload,\r\n    appControl,\r\n    sessionID\r\n  );\r\n  \r\n  let describe={};\r\n  try {\r\n    await restafedit.scrollTable(\"first\", tappEnv);\r\n    let tableSummary = await restafedit.getTableSummary(tappEnv);\r\n    \r\n    describe = {\r\n      table: iTable,\r\n      tableSummary: tableSummary,\r\n      columns: tappEnv.state.columns,\r\n      data: (csv === false ) ? tappEnv.state.data : rows2csv(tappEnv.state.data)\r\n    };\r\n  } catch (err) {\r\n    console.log(err);\r\n    describe = {error: err};\r\n  }\r\n  return describe;\r\n}\r\n\r\nexport default functions;\r\n\r\n/*\r\nasync function _contextData(params, _appEnv, gptControl) {\r\n  let { file, action } = params;\r\n  let { openai, assistant } = gptControl;\r\n\r\n  if (action === 'upload') {\r\n    const fileid = await openai.files.create({\r\n      file: fs.createReadStream(file, 'utf8'),\r\n      purpose: \"assistants\",\r\n   });\r\n   console.log('.......................', fileid);\r\n    const assistantFileid = await openai.beta.assistants.files.create(\r\n      assistant.id, {file_id: fileid.id});\r\n    console.log(assistantFileid);\r\n    return `File ${file} added to assistant`;\r\n  }\r\n  try {\r\n    let src = await fss.readFile(file, \"utf8\");\r\n    return src;\r\n  } catch (err) {\r\n    console.log(err);\r\n    return \"Error reading file \" + file;\r\n  }\r\n}\r\n*/","/*\r\n* Copyright © 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n* SPDX-License-Identifier: Apache-2.0\r\n*/\r\nfunction logAsArray(log) {\r\n  let logText = [];\r\n  // eslint-disable-next-line array-callback-return\r\n  log.map((data) => {\r\n    let line = data.line.replace( /(\\r\\n|\\n|\\r)/gm, \"\" );\r\n    if ( line.length === 0 ) {\r\n       logText.push('   ');\r\n    } else {\r\n     logText.push(line);\r\n    }\r\n  });\r\n  return logText;\r\n \r\n}\r\nexport default logAsArray;","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\nimport functions from './functions.js';\r\nimport instructions from './instructions.js';\r\n/**\r\n * @description Function specs for the assistant\r\n * @private\r\n * @function functionSpecs\r\n * @returns {object} - object containing specs, tools, functionList\r\n * \r\n */\r\n\r\nfunction functionSpecs(provider, code, retrieval) {\r\n  let specs = [\r\n    _listSASObjectsFunctionSpec,\r\n    _listSASDataLibFunctionSpec,\r\n    _listSASTablesFunctionSpec,\r\n    _listColumnsFunctionSpec,\r\n    _describeTableSpec,\r\n    _getDataFunctionSpec,\r\n   // _runSASFunctionSpec,\r\n    _keywordsFunctionSpec,\r\n   // _contextDataFunctionSpec,\r\n  ];\r\n\r\n\r\n  // Create tools array  for use with Assistant API\r\n  let tools = [];\r\n  if (code) {\r\n    tools.push({ type: 'code_interpreter' });\r\n  }\r\n  if (retrieval) {\r\n    tools.push({ type: 'retrieval' });\r\n  }\r\n\r\n  specs.forEach((f) => {\r\n    let r = {\r\n      type: \"function\",\r\n      function: Object.assign({}, f),\r\n    };\r\n    tools.push(r);\r\n  });\r\n\r\n  let functionList = functions();\r\n\r\n  return { specs: specs, tools: tools, functionList: functionList, instructions: instructions() };\r\n}\r\n\r\nconst _getDataFunctionSpec = {\r\n  name: '_getData',\r\n  description: `Fetch data from a  table like casuser.cars.\r\n                To limit the number of rows, specify the limit parameter.\r\n                If format is true, then the data will be formatted.\r\n                Use standard where clause to filter the data.\r\n                To return data in csv format, specify csv = true. Default is false.`,\r\n  parameters: {\r\n    properties: {\r\n      table: {\r\n        type: 'string',\r\n        description:\r\n          'The table to setup. The form of the table is casuser.cars',\r\n      },\r\n      limit: {\r\n        type: 'integer',\r\n        description: 'Fetch only the specified number of rows'\r\n      },\r\n      'format': {\r\n        type: 'boolean',\r\n        description: 'Format the string - true or false'\r\n      },  \r\n      where: {\r\n        type: 'string',\r\n        description: 'A where clause like Make eq \"Audi\"'\r\n      },\r\n      csv: {\r\n        type: 'boolean',\r\n        description: 'Return data in csv format - true or false'\r\n      }\r\n    },\r\n    type: 'object',\r\n    required: ['table'],\r\n  },\r\n};\r\nconst _listSASObjectsFunctionSpec = {\r\n  name: '_listSASObjects',\r\n  description:\r\n    'list SAS resources like reports, files, folders. Specify the limit parameter to limit the number of items returned',\r\n  parameters: {\r\n    properties: {\r\n      resource: {\r\n        type: 'string',\r\n        description:\r\n          'The objecttable to setup. The form of the table is casuser.cars',\r\n      },\r\n      limit: {\r\n        type: 'integer',\r\n        description: 'Get this many items',\r\n      },\r\n    },\r\n    type: 'object',\r\n    required: ['resource', 'limit'],\r\n  },\r\n};\r\nconst _listSASDataLibFunctionSpec = {\r\n  name: '_listSASDataLib',\r\n  description:\r\n    `list available SAS libs, calibs, librefs.\r\n     A example would be list libs. \r\n     If limit is not is specified, then the function \r\n     will return the first 10 libs.\r\n     Optionally allow user to specify the source as cas or compute.`,\r\n  parameters: {\r\n    properties: {\r\n      limit: {\r\n        type: 'integer',\r\n        description: 'Return only this many libs. If not specified, then return 10 libs.',\r\n      },\r\n      source: {\r\n        type: 'string',\r\n        description: 'The source of the data. cas or compute',\r\n        enum: ['cas', 'compute'],\r\n      }\r\n    },\r\n  type: 'object',\r\n  }\r\n};\r\nconst _listSASTablesFunctionSpec = {\r\n  name: '_listSASTables',\r\n  description:\r\n    `for a given library, lib or caslibs get the list of available tables\r\n    (ex: list tables for Samples)\r\n    Optionally let user specify the source as cas or compute.`,\r\n  parameters: {\r\n    properties: {\r\n      library: {\r\n        type: 'string',\r\n        description: 'A SAS library like casuser, sashelp, samples',\r\n      },\r\n      limit: {\r\n        type: 'integer',\r\n        description:\r\n          'Return only this many tables. If not specified, then return 10 tables.',\r\n      },\r\n      source: {\r\n        type: 'string',\r\n        description: 'The source of the data. cas or compute',\r\n        enum: ['cas', 'compute'],\r\n      }\r\n    },\r\n    type: 'object',\r\n    required: ['library'], \r\n  },\r\n};\r\nconst _listColumnsFunctionSpec = {\r\n  name: '_listColumns',\r\n  description: 'Get schema or columns for specified table. Table is of the form sashelp.cars',\r\n  parameters: {\r\n    properties: {\r\n      table: {\r\n        type: 'string',\r\n        description: 'A table like sashelp.cars',\r\n      },\r\n    },\r\n    type: 'object',\r\n    required: ['table'],\r\n  },\r\n};\r\nconst _describeTableSpec = {\r\n  name: '_describeTable',\r\n  description: 'Describe the table like sashelp.cars . return information on the table like columns, types, keys. Optionally format the data',\r\n  parameters: {\r\n    properties: {\r\n      table: {\r\n        type: 'string',\r\n        description: 'A table like sashelp.cars',\r\n      },\r\n      format: {\r\n        type: 'boolean',\r\n        description: 'If true then format the data'\r\n      },\r\n    },\r\n    type: 'object',\r\n    required: ['table'],\r\n  },\r\n};\r\nconst _runSASFunctionSpec = {\r\n  name: '_runSAS',\r\n  description:\r\n    'run the specified sas program',\r\n  parameters: {\r\n    properties: {\r\n      file: {\r\n        type: 'string',\r\n        description: 'this is the file to run',\r\n      },\r\n    },\r\n    type: 'object',\r\n    required: ['program']\r\n  },\r\n};\r\n\r\nconst _keywordsFunctionSpec = {\r\n  name: '_keywords',\r\n  description: 'format a comma-separated keywords like a,b,c into html, array, object',\r\n  parameters: {\r\n   \r\n    properties: {\r\n      keywords: {\r\n        type: 'string',\r\n        description: 'A comma-separated list of keywords like a,b,c',\r\n      },\r\n      format: {\r\n        type: 'string',\r\n        enum: ['html', 'array', 'object'],\r\n        description: 'Format the string'\r\n      },\r\n    },\r\n    type: 'object',\r\n    required: ['keywords', 'format']\r\n  },\r\n}\r\n\r\nexport default functionSpecs;\r\n\r\n/*\r\nconst _contextDataFunctionSpec = {\r\n  name: '_contextData',\r\n  description:\r\n    `This is quick way to add some asset to current contect\r\n     User issues a prompt like context <some string>\r\n     the string is usually some string.\r\n     `,\r\n  parameters: {\r\n    properties: {\r\n      asset: {\r\n        type: 'string',\r\n        description: 'the asset to add to the context',\r\n      },\r\n    },\r\n    type: 'object',\r\n    required: ['file'],\r\n  },\r\n};\r\n*/","\r\n/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @private\r\n * @description - Map openai to azureai assistantApi\r\n * @function apiMapper\r\n * @param {object} client - openai client\r\n * @param {string} provider - openai or azureai\r\n * returns {assistantApi} - assistantApi - return the apiAssistant object with entries for openai or azureai\r\n * @example - Allows this library to work for both openai and azureai Assistant\r\n */\r\n\r\n/*\r\n* spreading and extracting args since one of the goals is help learn the api\r\n* makes it easier to come back a few months later and understand what is going on\r\n*/\r\nfunction apiMapper(client, provider) {\r\n\r\n  const listAssistants = (client) => (...args) =>{\r\n    let [options] = args;\r\n    return client.beta.assistants.list(options)\r\n  }\r\n  const getAssistant = (client) => (...args) =>{\r\n    let [id] = args;\r\n    return client.beta.assistants.retrieve(id)\r\n  }\r\n  const deleteAssistant = (client) => (...args) =>{\r\n    let [id] = args;\r\n    return client.beta.assistants.del(id)\r\n  }\r\n  const createAssistant = (client) => (...args) =>{\r\n    let [options] = args;\r\n\r\n    return client.beta.assistants.create(options)\r\n  }\r\n\r\n  const updateAssistant = (client) => (...args) =>{\r\n    let [id, options] = args;\r\n    if (options.fileIds) {\r\n      options.file_ids = options.fileIds;\r\n      delete options.fileIds;\r\n    }\r\n    return client.beta.assistants.update(id, options);\r\n  }\r\n\r\n\r\n  const listMessages = (client) => (...args) =>{\r\n    let [threadid, options] = args;\r\n    return client.beta.threads.messages.list(threadid, options)\r\n  }\r\n\r\n  const createMessage = (client) => (...args) =>{\r\n    let [threadid, role, content] = args;\r\n    let options = {\r\n      role: role,\r\n      content: content\r\n    }\r\n\r\n    return client.beta.threads.messages.create(threadid, options);\r\n  }\r\n\r\n  const createThread = (client) => (...args) =>{\r\n    let [metadata] = args;\r\n    if (metadata == null) {\r\n      metadata = {};\r\n    }\r\n    return client.beta.threads.create(metadata)\r\n  }\r\n  const getThread = (client) => (...args) =>{\r\n    let [id] = args;\r\n    return client.beta.threads.retrieve(id)\r\n  }\r\n\r\n  const deleteThread = (client) => (...args) =>{\r\n    let [id] = args;\r\n    return client.beta.threads.del(id)\r\n  }\r\n\r\n  const createRun = (client) => (...args) =>{\r\n    let [threadid, options] = args;\r\n   // options.thread = threadid;\r\n    let newOptions = {\r\n      assistant_id: options.assistantId,\r\n      instructions: options.instructions,\r\n    }\r\n    return client.beta.threads.runs.create(threadid, newOptions);\r\n  }\r\n  const getRun = (client) => (...args) =>{\r\n   let [threadid, runid] = args;\r\n    return client.beta.threads.runs.retrieve(threadid, runid)\r\n  }\r\n\r\n  const submitToolOutputsToRun = (client) => (...args) =>{\r\n    let [ threadid, runid, options] = args;\r\n    return client.beta.threads.runs.submitToolOutputs(threadid, runid, options  );\r\n  }\r\n  const listRuns= (client) => (...args) =>{\r\n    let [id] = args;\r\n    return client.beta.threads.runs.list(id);\r\n  }\r\n  const cancelRun = (client) => (...args) =>{\r\n    let [threadid, runid] = args;\r\n    return client.beta.threads.runs.cancel(threadid, runid);\r\n  }\r\n\r\n  const uploadFile = (client) => (...args) =>{\r\n    let [fileHandle, purpose] = args;\r\n    debugger;\r\n    let options = {\r\n      file: fileHandle,\r\n      purpose: purpose\r\n    }\r\n    debugger;\r\n    return client.files.create(options);\r\n  }\r\n  let assistantApi = client;\r\n  if (provider === 'openai') {\r\n    assistantApi = {\r\n      listAssistants: listAssistants(client),\r\n      createAssistant: createAssistant(client),\r\n      getAssistant: getAssistant(client),\r\n      deleteAssistant: deleteAssistant(client),\r\n      updateAssistant: updateAssistant(client),\r\n    \r\n      createThread: createThread(client),\r\n      getThread: getThread(client),\r\n      deleteThread: deleteThread(client),\r\n\r\n      createMessage: createMessage(client),\r\n      listMessages: listMessages(client),\r\n     \r\n      uploadFile: uploadFile(client),\r\n      \r\n      createRun: createRun(client),\r\n      getRun: getRun(client),\r\n      listRuns: listRuns(client),\r\n      cancelRun: cancelRun(client),\r\n      submitToolOutputsToRun: submitToolOutputsToRun(client)\r\n      };\r\n\r\n  }\r\n  return assistantApi;\r\n}\r\nexport default apiMapper;\r\n","/*\r\n * Copyright © 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport OpenAI from 'openai';\r\n\r\nimport { AssistantsClient, AzureKeyCredential } from \"@azure/openai-assistants\";\r\nimport loadThread from './loadThread.js';\r\nimport createAssistant from './createAssistant.js';\r\nimport functionSpecs from './builtins/functionSpecs.js';\r\nimport setupViya from './builtins/lib/setupViya.js';\r\nimport apiMapper from './apiMapper.js';\r\n\r\n/**\r\n * @async\r\n * @function setupAssistant\r\n * @description   Setup the assistant\r\n * @param {config} config - configuration object\r\n * @returns {promise} - return gptControl object}\r\n * @example\r\n *  Local rules:\r\n *  To avoid creating lots of assistants and threads during\r\n * development, you can use the same assistant and thread.\r\n * \r\n * Assistant:\r\n *   If assistantid is known set it as assistantid. else set it as '0'\r\n *  If assistantid is '0' then the assistantName is used to find the assistant.\r\n * If assistantName is not found, a new assistant is created using the same name\r\n *   \r\n * Threads:\r\n *  When a thread is created for an Assistant, the threadid is stored in the assistant metadata.  \r\n *  So on the next setupAssistant call - if either assistantid or assistantName is specified\r\n *  the threadid is retrieved from the assistant metadata.\r\n * \r\n * These local rules are probably not ideal, but helps during development.\r\n * \r\n *  A sample configuration object is shown below\r\n * let config = {\r\n    provider: 'azureai', // Depending on who your account is with\r\n    model: process.env.AZUREAI_MODEL,// model name\r\n    credentials: {\r\n      key: process.env.AZUREAI_KEY, // obtain from provider\r\n      endPoint: process.env.AZUREAI_ENDPOINT // obtain from provider\r\n    },\r\n    assistantid: '0', //Replace with valid assistant id or 0 for new assistant\r\n                 \r\n    assistantName: \"SAS_ASSISTANT\", //if assistantid is 0, then either an exting id with that name will be used or a new assistant will be created\r\n    threadid: '-1', // some valid threadid or 0 for new thread or-1 for existing thread stored in Assistant metadata\r\n    domainTools: {tools: [], functionList: {}, instructions: '', replace: false},\r\n\r\n    // fill in the host and token to authenticate to Viya\r\n    // set the source to cas or compute. \r\n    // if you want to run the AI assistant without Viya set source to none\r\n    viyaConfig: {\r\n      logonPayload: {\r\n        authType: 'server',\r\n        host: host,  // viya url - https://myviyaserver.acme.com\r\n        token: token,// viya token  - obtained from sas-viya auth login|loginCode\r\n        tokenType: 'bearer'  \r\n        },\r\n      source: 'cas' \r\n    },\r\n    code: true,\r\n    retrieval: false\r\n}\r\n * \r\n * \r\n */\r\n\r\nasync function setupAssistant(config) {\r\n  let {credentials } = config;\r\n  let {key, endPoint} = credentials;\r\n  // create the client\r\n  \r\n  let client = null;\r\n  if (config.provider === 'openai') {\r\n     client = new OpenAI({ apiKey: key, dangerouslyAllowBrowser: true });\r\n  } else {\r\n    client = new AssistantsClient(endPoint, new AzureKeyCredential(key, {}));\r\n  }\r\n\r\n  //\r\n  // now add user specs and functions.\r\n  // In pass 1 the user list is prepended to the default list\r\n\r\n  let builtinTools = functionSpecs(config.provider, false,false);\r\n  let specs={};\r\n  if (config.domainTools.replace === true) {\r\n    specs = config.domainTools;\r\n  } else {\r\n    let userTools = config.domainTools.tools.concat(builtinTools.tools);\r\n    let userFunctions = Object.assign(config.domainTools.functionList, builtinTools.functionList);\r\n    let userInstructions = (config.instructions)  ? config.instructions + builtinTools.instructions : builtinTools.instructions;\r\n    specs = {tools: userTools, functionList: userFunctions, instructions: userInstructions};\r\n  }\r\n  //moved this here to handle user override of all builtin tools\r\n\r\n  if (config.code) {\r\n    specs.tools.push({ type: 'code_interpreter' });\r\n  }\r\n  if (config.retrieval) {\r\n    specs.tools.push({ type: 'retrieval' });\r\n  }\r\n  let gptControl = {\r\n    provider: config.provider,\r\n    model: config.model,\r\n    domainTools: specs,\r\n    instructions: specs.userInstructions,\r\n\r\n    assistantName: config.assistantName,\r\n    assistant: null,\r\n    assistantid: config.assistantid,\r\n\r\n    thread: null,\r\n    threadid: config.threadid,\r\n\r\n    appEnv: null,\r\n    client: client,\r\n    run: null,\r\n    assistantApi: apiMapper(client, config.provider),\r\n    code: config.code, \r\n    retrieval: config.retrieval, // remove this when azureai supports retrieval\r\n    userData: config.userData,\r\n    user: config.user\r\n  };\r\n  \r\n  // setup Viya connections\r\n  gptControl.appEnv = await setupViya(config.viyaConfig);\r\n  gptControl.appEnv.userData = config.userData;\r\n  gptControl.appEnv.user = config.user;\r\n  \r\n  // create assistant and thread\r\n  gptControl.assistant = await createAssistant(gptControl);\r\n  \r\n  gptControl.thread = await loadThread(gptControl);\r\n  \r\n  gptControl.threadid = gptControl.thread.id;// just for convenience\r\n  console.log('--------------------------------------');\r\n  console.log('Current session:');\r\n  console.log('Provider: ', gptControl.provider);\r\n  console.log('Model: ', gptControl.model);\r\n  console.log(\r\n    'Assistant: ',\r\n    gptControl.assistant.name,\r\n    'Assistant id',\r\n    gptControl.assistant.id\r\n  );\r\n  console.log('Threadid: ', gptControl.thread.id);\r\n  console.log('Viya Source:', gptControl.appEnv.source);\r\n  console.log('--------------------------------------');\r\n  return gptControl;\r\n}\r\nexport default setupAssistant;\r\n","\r\n/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @description Instructions for the assistant\r\n * @private\r\n * @returns {string} - instructions for the assistant\r\n */\r\nfunction instructions() {\r\n return `\r\n You are a Assistant designed for SAS users. You can help SAS users with their SAS related questions and provide information\r\n  on topics like libraries, reports, tables. You can also fetch data from tables and run SAS programs. You can also help answer questions about the \r\n  data that has been returned from previous queries.\r\n\r\n  If the response from a tool is of the form [{a:1,b:2},{a:1,b:3}] format the table as a html table element like this\r\n  '<table>\r\n     <tr>\r\n       <th>a</th> \r\n      <th>b</th>\r\n     </tr>\r\n    <tr>\r\n    <td>1</td>\r\n    <td>2</td>\r\n    </tr>\r\n    <tr>\r\n   <td>2</td>\r\n   <td>3</td>\r\n   </tr>\r\n   </table>' \r\n  \r\n  if the response from a tool is of the form [1,2,3] then return the data as a html unodered list to the user.\r\n  You can also allow users to attach files to the assistant. \r\n\r\n  `;\r\n}\r\nexport default instructions;\r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n \r\n\r\n","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\n/**\r\n * Setup the Viya environment\r\n * @param {string} source - cas or compute\r\n * @returns {object} - appEnv\r\n * @async\r\n */\r\n \r\nimport restaf from '@sassoftware/restaf';\r\nimport restaflib from '@sassoftware/restaflib';\r\nimport restafedit from '@sassoftware/restafedit';\r\n\r\n\r\nasync function setupViya(viyaConfig) {\r\n\r\n let appEnv=  {\r\n  host: null,\r\n  logonPayload: null,\r\n  store: null,\r\n  source: 'none',\r\n  currentSource: 'none',\r\n  session: null,\r\n  servers: null,\r\n  serverName: null,\r\n  casServerName: null, \r\n  sessionID: null,\r\n  compute: {},\r\n  cas: {},\r\n  restaf: restaf,\r\n  restaflib: restaflib,\r\n  restafedit: restafedit\r\n\r\n}\r\n\r\n  if (viyaConfig == null) {\r\n    return appEnv;\r\n  }\r\n  if (viyaConfig.source == 'none') {\r\n    appEnv.userData = viyaConfig.userData;\r\n    appEnv.logonPayload = viyaConfig.logonPayload;\r\n    appEnv.currentSource = 'none';\r\n    return appEnv;\r\n  }\r\n\r\n  // setup Viya\r\n  let {source, logonPayload} = viyaConfig;\r\n  let sources = source.split(',');\r\n  let defaultSource = sources[0];\r\n  appEnv.currentSource = defaultSource;\r\n\r\n  appEnv.host= logonPayload.host;\r\n    // get list of sources. First one in list is the default\r\n \r\n\r\n  // logon to the server\r\n  let store = restaf.initStore({casProxy: true});\r\n  await store.logon(logonPayload);\r\n  appEnv.host = logonPayload.host;\r\n  appEnv.logonPayload = logonPayload;\r\n  appEnv.store = store;\r\n  \r\n  // create session and server objects\r\n  // Allow sessions for both servers and cas\r\n  \r\n  // cas service\r\n  if (source.indexOf('cas') >= 0 ) {\r\n    let {session, servers} = await restaflib.casSetup(store, null);\r\n    let casServerName = session.links('execute', 'link', 'server');\r\n    appEnv.cas = {\r\n      session: session,\r\n      servers: servers,\r\n      casServerName: casServerName\r\n    }\r\n    let ssid = await store.apiCall(session.links('self'));\r\n    appEnv.cas.sessionID = ssid.items('id');\r\n    if (defaultSource === 'cas') {\r\n      appEnv.source = 'cas';\r\n      appEnv.session = session;\r\n      appEnv.servers = servers;\r\n      appEnv.serverName = casServerName;\r\n      appEnv.casServerName = casServerName;\r\n      appEnv.sessionID = appEnv.cas.sessionID;\r\n    }\r\n  } \r\n\r\n  // compute service\r\n  if (source.indexOf('compute') >= 0) {\r\n    appEnv.compute = {\r\n      servers: null\r\n    }\r\n    try{ \r\n      let session = await restaflib.computeSetup(store);\r\n      let ssid = await store.apiCall(appEnv.session.links('self'));\r\n      appEnv.compute.sessionID = ssid.items('id');\r\n      if (defaultSource === 'compute') {\r\n        appEnv.source = 'compute';\r\n        appEnv.session = session;\r\n        appEnv.servers = null;\r\n        appEnv.serverName = null;\r\n        appEnv.sessionID = appEnv.compute.sessionID;\r\n      }\r\n    }\r\n    catch (e) {\r\n      console.log(JSON.stringify(e, null, 4));\r\n    }\r\n  }\r\n  return appEnv;\r\n}\r\nexport default setupViya;","/*\r\n * Copyright © 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\n/**\r\n * @async\r\n * @private\r\n * @function createAssistant\r\n * @description   Create a new assistant\r\n * @param {gptControl} gptControl - gptControl object\r\n * @returns {promise} - return assistant object\r\n */\r\n\r\nasync function createAssistant(gptControl) {\r\n  let {\r\n    assistantName,\r\n    model,\r\n    assistantid,\r\n    instructions,\r\n    domainTools,\r\n    assistantApi,\r\n  } = gptControl;\r\n\r\n  // get assistant by assistantid\r\n  debugger;\r\n  try {\r\n    if (!(assistantid === \"0\" || assistantid === \"-1\")) {\r\n      console.log(\"Using assistantid \", assistantid);\r\n      let assistant = await assistantApi.getAssistant(assistantid);\r\n      gptControl.assistant = assistant;\r\n      gptControl.assistantid = assistant.id;\r\n      return assistant;\r\n    }\r\n\r\n    // create args for assistant create\r\n    let createArgs = {\r\n      name: assistantName,\r\n      instructions: instructions,\r\n      model: model,\r\n      tools: domainTools.tools,\r\n    };\r\n\r\n    //New local rules\r\n    // if assistantid is -1, try to find the assistant by name.\r\n    //    then create a new assistant with the same name\r\n    // if assistantid is 0, create a new assistant with the name\r\n\r\n    if (assistantid === \"-1\") {\r\n      console.log(\"Attempting to find assistant by name \", assistantName);\r\n      const myAssistants = await assistantApi.listAssistants({\r\n        order: \"desc\",\r\n        limit: \"100\",\r\n      });\r\n      let assistant = myAssistants.data.find((a) => {\r\n        if (a.name === assistantName) {\r\n          return a;\r\n        }\r\n      });\r\n      if (assistant != null) {\r\n        console.log(\"Found assistant \", assistantName, assistant.id)\r\n        return assistant;\r\n      }\r\n    }\r\n\r\n    // fall thru to create a new assistant\r\n    console.log(\"Creating new assistant\");\r\n    let assistant = await assistantApi.createAssistant(createArgs);\r\n    gptControl.assistantid = assistant.id;\r\n    gptControl.assistant = assistant;\r\n\r\n    return assistant;\r\n  } catch (error) {\r\n    console.log(error);\r\n    throw new Error(\r\n      `Error status ${error.status}. Failed to create assistant. See console for details.`\r\n    );\r\n  }\r\n}\r\nexport default createAssistant;\r\n","/*\r\n * Copyright © 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\n/**\r\n * @async\r\n * @private\r\n * @function loadThread\r\n * @description   new thread or open existing thread\r\n * @param {gptControl} gptControl - gptControl object\r\n * @returns {promise} - return thread object\r\n */\r\nasync function loadThread(gptControl) {\r\n  let {assistant, assistantApi} = gptControl;\r\n  let thread = null;\r\n  let threadid = gptControl.threadid;\r\n\r\n  // a little verbose so as not to get confused :-)\r\n\r\n  try {\r\n    // local rules: try to use the last used thread\r\n    \r\n    // if threadid is specified, use it\r\n\r\n    if (!(threadid === '0' || threadid === '-1')) {\r\n      console.log('Using threadid ', threadid);\r\n      thread = await assistantApi.getThread(threadid);\r\n      return thread;\r\n    }\r\n\r\n    if (threadid === '-1' ){ \r\n      threadid = assistant.metadata.lastThread;\r\n      if (threadid != null)  {\r\n        console.log('Attempting to use previous ', threadid);\r\n        let thread = await assistantApi.getThread(threadid);\r\n        return thread;\r\n      }\r\n    }\r\n  // fall thru  to create a new thread\r\n  console.log('Creating new thread');\r\n  thread = await assistantApi.createThread();\r\n  let newAssistant = await assistantApi.updateAssistant(assistant.id, {metadata: {lastThread: thread.id}});\r\n  gptControl.assistant = newAssistant;\r\n\r\n  } catch (error) {\r\n    console.log(error); \r\n    throw new Error(`Error status ${error.status}. Failed to create thread. See console for details.`);\r\n  }\r\n  \r\n\r\n  // local rules: save the thread id in the assistant metadata\r\n  \r\n \r\n  return thread;\r\n}\r\nexport default loadThread;\r\n","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @async\r\n * @description Return the latest message from thread\r\n * @param {gptControl}  gptControl - client control object\r\n * @param {number} limit - limit the number of messages to return\r\n * @returns {promise} - messages - array of latest assistant messages[ {id, role, type, content}]\r\n * @example - This function will return latest assistant messages based on limit\r\n */\r\nasync function getLatestMessage(gptControl, limit) {  \r\n  let {thread, assistantApi} = gptControl;\r\n  \r\n  const messages = await assistantApi.listMessages(thread.id, {limit:limit});\r\n \r\n  let output = [];\r\n  let data = messages.data;\r\n  for (let i = 0; i < messages.data.length; i++){\r\n    let content = data[i].content[0];\r\n    if (data[i].role === 'assistant') {\r\n      output.push({id: data[i].id, role: data[i].role, type: content.type, content: content[content.type].value});\r\n    } else {\r\n      break;\r\n    }\r\n  }\r\n  if (output.length > 1) {\r\n    output = output.reverse();\r\n  }\r\n  return output;\r\n\r\n}\r\nexport default getLatestMessage;","\r\n/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\n/**\r\n * @async\r\n * @private\r\n * @description - Poll run status since there is no streaming support\r\n * @function pollRun\r\n * @param {object} run - active run object \r\n * @param {gptControl} gptControl - gpt  session control object\r\n * @returns {object} - runStatus from client.beta.threads.runs.retrieve\r\n * @example - Will wait for completion(!(queued,in_progress, cancelling))\r\n */\r\nasync function pollRun(run, gptControl) {\r\n  let {assistantApi, thread} = gptControl;\r\n  let done = null;\r\n  let runStatus = null;\r\n  function sleep(ms) {\r\n    return new Promise((resolve) => setTimeout(resolve, ms));\r\n  }\r\n  // Since there is no streaming support, sleep and poll the status\r\n  do {\r\n    \r\n\r\n   runStatus = await assistantApi.getRun(thread.id, run.id);\r\n    \r\n    console.log(\"-------------------\", runStatus.status);\r\n    if ( !(runStatus.status === \"queued\" ||runStatus.status === \"in_progress\" ||\r\n          runStatus.status === \"cancelling\")) {\r\n      \r\n      done = runStatus.status;\r\n    } else {\r\n      await sleep(2000);\r\n      console.log(\"waited 2000 ms\");\r\n    }\r\n  } while (done === null);\r\n\r\n  return runStatus;\r\n\r\n}\r\nexport default pollRun;","\r\n/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport pollRun from \"./pollRun.js\";\r\n\r\n/**\r\n * @async\r\n * @private\r\n * @function required_action\r\n * @description   Get the required action from the run status and execute the action\r\n * @param {object} runStatus - run status object\r\n * @param {gptControl} gptControl - gptControl object\r\n * @returns {promise} - return the output status\r\n *  \r\n * @example\r\n *  let outputStatus = await required_action(runStatus, gptControl);\r\n */\r\n\r\nasync function required_action(runStatus,gptControl) {\r\n  let{assistantApi,appEnv, domainTools, provider, thread, run} = gptControl;\r\n  let {functionList} = domainTools;\r\n  \r\n  // get the required actions from the run status\r\n\r\n  let requiredActions = (provider === 'openai') \r\n                          ? runStatus.required_action.submit_tool_outputs.tool_calls\r\n                          : runStatus.requiredAction.submitToolOutputs.toolCalls;\r\n  \r\n  let toolsOutput = [];\r\n  for (let action of requiredActions) {\r\n    let functionName = action.function.name;\r\n\r\n    console.log('Requested function: ', functionName);\r\n    let params = JSON.parse(action.function.arguments);\r\n    \r\n    let target = functionList[functionName];\r\n    if (target == null){\r\n      let err = (`Function ${functionName} not found. \r\n      Probable causes: \r\n        Using thread that had outdated tool references.\r\n        Currrent specs point has mistmatch with function name\r\n        `);\r\n      toolsOutput.push(setError(action.id, err, provider)); \r\n    } else {\r\n      try {\r\n        \r\n        let response = await functionList[functionName](params, appEnv, gptControl);\r\n        if (provider === 'openai') {\r\n          toolsOutput.push({\r\n            tool_call_id: action.id,\r\n            output: JSON.stringify(response),\r\n          });\r\n        } else {\r\n          toolsOutput.push({\r\n            toolCallId: action.id,\r\n            output: JSON.stringify(response),\r\n          });\r\n        }\r\n      }\r\n      catch(err){\r\n        toolsOutput.push(setError(action.id, err, provider));\r\n      }\r\n    }\r\n }\r\n// submit the outputs to the thread\r\n \r\n let newRun = (provider === 'openai') \r\n            ? await assistantApi.submitToolOutputsToRun(\r\n                thread.id, run.id, { tool_outputs: toolsOutput })\r\n            : await assistantApi.submitToolOutputsToRun( \r\n                thread.id, run.id, toolsOutput);\r\n\r\n// wait for output to appear in the thread messages\r\n let outputStatus = await pollRun(newRun, gptControl);\r\n\r\nreturn outputStatus;\r\n}\r\nfunction setError(actionid, error, provider){\r\n  if (provider === 'openai') {\r\n    return {tool_call_id: actionid, output: JSON.stringify(error)};\r\n  } else {\r\n    return {toolCallId: actionid, output: JSON.stringify(error)};\r\n  }\r\n}\r\n\r\nexport default required_action;","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\nimport getLatestMessage from './getLatestMessage.js';\r\nimport required_action from './required_action.js';\r\nimport pollRun from './pollRun.js';\r\n//import toolsOutput from './toolsOuput.js';\r\n\r\n/**\r\n * @async\r\n * @description - Run the latest prompt from the user\r\n * @function runAssistant\r\n *\r\n * @param {gptControl} gptControl - gpt  session control object\r\n * @param {string} prompt - user's prompt\r\n * @param {string} instructions - Additional instructions for the run \r\n * @returns {promise} - response from GPT(can be text, string, html etc...)\r\n * @example - This function will run the assistant with the prompt and return the response from the assistant.\r\n * @example \r\n *  let prompt = 'fetch 20 records from cars from public';\r\n *  let promptInstructions = 'some instructions';\r\n *  let response = await runAssistant(gptControl, prompt, promptInstructions); \r\n *  console.log(response);\r\n */\r\n\r\n\r\nasync function runAssistant(gptControl,prompt, instructions) {\r\n  let {thread, assistantApi, appEnv } = gptControl;\r\n\r\n  //add the user request to thread\r\n  try {\r\n    let _newMessage = await assistantApi.createMessage(thread.id,'user',prompt);\r\n  } catch (error) {\r\n    \r\n    console.log(error.status);\r\n    console.log(error.error);\r\n     throw new Error(`\r\n     Request failed on adding user message to thread.\r\n     See error below. \r\n     If thread is active, you can try canceling the run.\r\n     ${error.status} ${error.error}`);\r\n  }\r\n  // now run the thread\r\n  // assume caller will catch any thrown errors\r\n  let r = await runPrompt(gptControl, appEnv, instructions);\r\n  return r;\r\n}\r\nasync function runPrompt(gptControl, appEnv, instructions) {\r\n  let { assistantApi, assistant, thread } = gptControl;\r\n  let runArgs = {\r\n    assistantId: assistant.id,\r\n    instructions: instructions != null ? instructions : '',\r\n  };\r\n  // Run the assistant with the prompt and poll for completion\r\n  \r\n  let run = await assistantApi.createRun(thread.id, runArgs);\r\n  gptControl.run = run;\r\n  let runStatus = await pollRun(run, gptControl);\r\n\r\n  //check for completion status\r\n  let message;\r\n  if (runStatus.status === 'completed') {\r\n    message = await getLatestMessage(gptControl, 5);\r\n  } else if (runStatus.status === 'requires_action') {\r\n    // make sure that required_action closes the thread run\r\n    let r = await required_action(runStatus, gptControl, appEnv);\r\n    console.log('getting latest message ')\r\n    message = await getLatestMessage(gptControl, 5);\r\n  } else {\r\n    message = [{ runStatus: runStatus.status }];\r\n  }\r\n  return message;\r\n}\r\nexport default runAssistant;\r\n\r\n//https://platform.openai.com/docs/guides/text-generation/chat-completions-assistantApi\r\n","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @async\r\n * @description - Delete assistant\r\n * @function closeAssistant\r\n * @param {gptControl} gptControl - gpt session control object\r\n * @param {object} [assistantid] - Assistant id\r\n * @returns {promise} - status string \r\n */\r\nasync function deleteAssistant(gptControl, assistantid) {\r\n  let { assistantApi, assistant } = gptControl;\r\n  console.log('in closeAssistant');\r\n  if (assistantid != null) {\r\n    try {\r\n      if (assistantid != null) {\r\n        await assistantApi.deleteAssistant(id);\r\n        return `Assistant ${assistantid} deleted.`\r\n      }\r\n    } catch (error) {\r\n      console.log(error);\r\n      throw new Error(`\r\n        Delete of assistant ${assistantid} failed`);   \r\n    }\r\n  }\r\n\r\n  try {\r\n    if (assistant.metadata.lastThread != null) {\r\n      let status = await assistantApi.deleteThread(assistant.metadata.lastThread);\r\n      console.log('Thread ${assistant.metadata.lastThread} deleted', status);\r\n      status = await assistantApi.deleteAssistant(assistant.id);\r\n      console.log(`Assistant ${assistant.name} deleted`, status);\r\n      return `Assistant ${assistant.name} deleted`;\r\n\r\n    }\r\n  } catch (error) {\r\n    console.log(error);\r\n    throw new Error(`Failed to delete session and thread\r\n    ${error}`);\r\n  }\r\n\r\n}\r\nexport default deleteAssistant;\r\n","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * \r\n * @description Return sepcified number of messages from thread\r\n * @private\r\n * @param {gptControl}  gptControl- client control object\r\n * @param {number} limit - limit the number of messages to return\r\n * @returns {promise} - messages - array of messages[ {id, role, type, content}]\r\n * @example - This function will return the specified number of messages from the thread\r\n * Typically the top 2 will be the assistant message and user's prompt\r\n */\r\nasync function getMessages(gptControl, limit) {  \r\n  let {thread, assistantApi} = gptControl;\r\n  const messages = await assistantApi.listMessages(thread.id, {limit:limit});\r\n  let output = messages.data.map((m) => {\r\n    let content = m.content[0];\r\n    return {id: m.id, role: m.role, type: content.type, content: content[content.type].value};\r\n  });\r\n  return output;\r\n\r\n}\r\nexport default getMessages;","\r\n/** \r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * \r\n * Upload a file and attach it to the assistant\r\n * @param {object} fileHandle - from host file system\r\n * @param {string}  purpose - assistants|Fine-turning\r\n * @param {gptControl} gptControl - gptControl object\r\n * @returns {promise} - return the final file ids from the assistant\r\n */\r\nasync function uploadFile(filename, fileHandle,content, purpose, gptControl) {\r\n  let { assistantApi, assistant, provider } = gptControl;\r\n\r\n  // get fileid\r\n\r\n \r\n  // really strange args for azure - not sure why they(both) coded it like this\r\n  debugger;\r\n  let fileId = (provider === 'openai') \r\n              ? await assistantApi.uploadFile(fileHandle,purpose)\r\n              : await assistantApi.uploadFile(content, purpose, {filename: filename});\r\n  \r\n  \r\n    // update the array of file ids in the assistant\r\n  let currentFileIds = [].concat(assistant.file_ids);\r\n  currentFileIds.push(fileId.id);\r\n  console.log('currentFiles ', currentFileIds);\r\n  \r\n  // looks like it is possible to create a file with null file id\r\n  currentFileIds = currentFileIds.filter((v) => v != null);\r\n  /*\r\n  if (gptControl.retrieval === false){\r\n    return currentFileIds;\r\n  }\r\n  */\r\n    // update assistant with the new array of  the fileids\r\n    try {\r\n      debugger;\r\n      let opts = {\r\n        fileIds: currentFileIds\r\n      };\r\n      let newAssistant = await assistantApi.updateAssistant(assistant.id, opts);\r\n      gptControl.assistant = newAssistant;\r\n    } catch (e) {\r\n      console.log(e);\r\n      throw new Error(`Failed to update assistant with new file ${filename}`);\r\n    }\r\n\r\n  return {notes: (gptControl.retrieval)? \"Retrieval enabled\" : \"Retrieval disabled\"}, currentFileIds;\r\n}\r\nexport default uploadFile;","/*\r\n * Copyright © 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n/**\r\n * @async\r\n * @description - Cancel a previous run (on user request)\r\n * @function cancelRun\r\n * @param {gptControl} gptControl - gpt  session control object\r\n * @param {string} [threadid] - thread id\r\n * @param {string} [runid] - run id\r\n * returns {promise} - status (null if no run or thread or failed to cancel)\r\n * @example - This function will cancel the run\r\n */\r\n\r\nasync function cancelRun(gptControl, threadid, runid) {\r\n  let {assistantApi, assistant, thread, run} = gptControl;  \r\n\r\n  if (threadid != null && runid != null) {\r\n    try {\r\n      console.log('Cancelling run', threadid, runid);\r\n      let status = await assistantApi.cancelRun(threadid, runid);\r\n      return status;\r\n    } catch (error) {\r\n      throw \"Error cancelling the run \", error, threadid, runid;\r\n    }\r\n  }\r\n  if (run == null || thread == null) {\r\n    return 'No run or thread to cancel';\r\n  }\r\n\r\n  try {\r\n    let runStatus = await assistantApi.getRun(thread.id, run.id);\r\n\r\n    if (runStatus.completed !== null || runStatus.status === \"cancelling\") {\r\n      return `Run ${run.id} status: ${runStatus.status} , completed: ${runStatus.completed}` \r\n    }\r\n    let status = await assistantApi.cancelRun(thread.id, run.id);\r\n    return status;\r\n  } catch (error) {\r\n    throw new Error(`\r\n    Cancel run failed.  \r\n    Best action is to simply wait for a while for it to timeout \r\n    The last alternative is to delete the Assistant ${assistant.name} and restart your session`);\r\n  }\r\n}\r\nexport default cancelRun;"],"names":["string2Table","table","source","iTable","lib","parts","split","length","name","rows2csv","arr","headers","Object","keys","join","rows","map","obj","line","sep","values","value","valueString","replace","trim","toString","value2String","async","_listSASObjects","params","appEnv","resource","limit","store","includes","toLowerCase","s","addServices","payload","qs","start","items","apiCall","links","itemsList","toJS","JSON","stringify","_listSASDataLib","r","restafedit","getLibraryList","_listSASTables","library","p","getTableList","_listColumns","_getData","_idescribeTable","data","_runSAS","gptControl","program","session","caslRun","computeRun","computeResults","restaflib","src","results","computeSummary","log","logText","push","logAsArray","_keywords","keywords","format","console","t","forEach","k","i","_describeTable","where","csv","sessionID","appControl","casServerName","computeContext","initialFetch","tappEnv","setup","logonPayload","describe","scrollTable","tableSummary","getTableSummary","columns","state","err","error","_getDataFunctionSpec","description","parameters","properties","type","required","_listSASObjectsFunctionSpec","_listSASDataLibFunctionSpec","enum","_listSASTablesFunctionSpec","_listColumnsFunctionSpec","_describeTableSpec","_keywordsFunctionSpec","apiMapper","client","provider","assistantApi","listAssistants","args","options","beta","assistants","list","createAssistant","create","getAssistant","id","retrieve","deleteAssistant","del","updateAssistant","fileIds","file_ids","update","createThread","metadata","threads","getThread","deleteThread","createMessage","threadid","role","content","messages","listMessages","uploadFile","fileHandle","purpose","files","file","createRun","runs","assistant_id","assistantId","instructions","getRun","runid","listRuns","cancelRun","cancel","submitToolOutputsToRun","submitToolOutputs","setupAssistant","config","credentials","key","endPoint","OpenAI","apiKey","dangerouslyAllowBrowser","AssistantsClient","AzureKeyCredential","builtinTools","code","retrieval","specs","tools","f","function","assign","functionList","functionSpecs","domainTools","concat","model","userInstructions","assistantName","assistant","assistantid","thread","run","userData","user","viyaConfig","host","currentSource","servers","serverName","compute","cas","restaf","defaultSource","initStore","casProxy","logon","indexOf","casSetup","ssid","computeSetup","e","setupViya","createArgs","order","find","a","Error","status","lastThread","newAssistant","loadThread","getLatestMessage","output","reverse","pollRun","done","runStatus","sleep","ms","Promise","resolve","setTimeout","setError","actionid","tool_call_id","toolCallId","runAssistant","prompt","runArgs","message","requiredActions","required_action","submit_tool_outputs","tool_calls","requiredAction","toolCalls","toolsOutput","action","functionName","parse","arguments","response","newRun","tool_outputs","runPrompt","getMessages","m","filename","fileId","currentFileIds","filter","v","opts","completed"],"mappings":"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"}