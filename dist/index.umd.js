!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("openai")):"function"==typeof define&&define.amd?define(["exports","openai"],e):e((t||self).assistantjs={},t.openai)}(this,function(t,e){function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=/*#__PURE__*/n(e),o=function(t,e){try{return Promise.resolve(t.client.beta.threads.messages.list(t.thread.id,{limit:e})).then(function(t){for(var e=[],n=t.data,r=0;r<t.data.length;r++){var o=n[r].content[0];if("assistant"!==n[r].role)break;e.push({id:n[r].id,role:n[r].role,type:o.type,content:o[o.type].value})}return e.length>1&&(e=e.reverse()),e})}catch(t){return Promise.reject(t)}};function i(t,e,n){if(!t.s){if(n instanceof u){if(!n.s)return void(n.o=i.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(i.bind(null,t,e),i.bind(null,t,2));t.s=e,t.v=n;var r=t.o;r&&r(t)}}var s=function(t,e,n){try{var r=n.client,o=null,s=null,c=function(t,e){var n;do{var r=t();if(r&&r.then){if(!a(r)){n=!0;break}r=r.v}var o=e();if(a(o)&&(o=o.v),!o)return r}while(!o.then);var s=new u,c=i.bind(null,s,2);return(n?r.then(l):o.then(f)).then(void 0,c),s;function l(n){for(r=n;a(o=e())&&(o=o.v),o;){if(o.then)return void o.then(f).then(void 0,c);if((r=t())&&r.then){if(!a(r))return void r.then(l).then(void 0,c);r=r.v}}i(s,1,r)}function f(n){if(n){do{if((r=t())&&r.then){if(!a(r))return void r.then(l).then(void 0,c);r=r.v}if(a(n=e())&&(n=n.v),!n)return void i(s,1,r)}while(!n.then);n.then(f).then(void 0,c)}else i(s,1,r)}}(function(){return Promise.resolve(r.beta.threads.runs.retrieve(t.id,e.id)).then(function(t){s=t,console.log("-------------------",s.status);var e=function(){if("queued"===s.status||"in_progress"===s.status||"cancelling"===s.status)return Promise.resolve(new Promise(function(t){return setTimeout(t,2e3)})).then(function(){console.log("waited 2000 ms")});o=s.status}();if(e&&e.then)return e.then(function(){})})},function(){return null===o});return Promise.resolve(c&&c.then?c.then(function(){return s}):s)}catch(t){return Promise.reject(t)}};const u=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,n){const r=new t,o=this.s;if(o){const t=1&o?e:n;if(t){try{i(r,1,t(this.v))}catch(t){i(r,2,t)}return r}return this}return this.o=function(t){try{const o=t.v;1&t.s?i(r,1,e?e(o):o):n?i(r,1,n(o)):i(r,2,o)}catch(t){i(r,2,t)}},r},t}();function a(t){return t instanceof u&&1&t.s}const c="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function l(t,e,n){if(!t.s){if(n instanceof f){if(!n.s)return void(n.o=l.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(l.bind(null,t,e),l.bind(null,t,2));t.s=e,t.v=n;var r=t.o;r&&r(t)}}var f=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,n){var r=new t,o=this.s;if(o){var i=1&o?e:n;if(i){try{l(r,1,i(this.v))}catch(t){l(r,2,t)}return r}return this}return this.o=function(t){try{var o=t.v;1&t.s?l(r,1,e?e(o):o):n?l(r,1,n(o)):l(r,2,o)}catch(t){l(r,2,t)}},r},t}();function h(t){return t instanceof f&&1&t.s}t.closeAssistant=function(t,e){try{return console.log("in closeAssistant"),Promise.resolve(!0)}catch(t){return Promise.reject(t)}},t.getLatestMessage=o,t.getMessages=function(t,e){try{return Promise.resolve(t.client.beta.threads.messages.list(t.thread.id,{limit:e})).then(function(t){return t.data.map(function(t){var e=t.content[0];return{id:t.id,role:t.role,type:e.type,content:e[e.type].value}})})}catch(t){return Promise.reject(t)}},t.runAssistant=function(t,e,n,r){try{var i=function(e){return Promise.resolve(function(t,e,n){try{var r=t.thread;return Promise.resolve(t.client.beta.threads.runs.create(r.id,{assistant_id:t.assistant.id,instructions:null!=n?n:""})).then(function(n){return Promise.resolve(s(r,n,t)).then(function(i){var u,a=function(){if("completed"===i.status)return Promise.resolve(o(t,5)).then(function(t){u=t});var a=function(){if("requires_action"===i.status)return Promise.resolve(function(t,e,n,r,o){try{var i=function(){return console.log("Adding output to messages"),Promise.resolve(u.beta.threads.runs.submitToolOutputs(e.id,n.id,{tool_outputs:d})).then(function(t){return Promise.resolve(s(e,t,r))})},u=r.client,a=r.specs.functionList,d=[],v=function(t,e,n){if("function"==typeof t[c]){var r,o,i,s=t[c]();if(function t(n){try{for(;!(r=s.next()).done;)if((n=e(r.value))&&n.then){if(!h(n))return void n.then(t,i||(i=l.bind(null,o=new f,2)));n=n.v}o?l(o,1,n):o=n}catch(t){l(o||(o=new f),2,t)}}(),s.return){var u=function(t){try{r.done||s.return()}catch(t){}return t};if(o&&o.then)return o.then(u,function(t){throw u(t)});u()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var a=[],d=0;d<t.length;d++)a.push(t[d]);return function(t,e,n){var r,o,i=-1;return function n(s){try{for(;++i<t.length;)if((s=e(i))&&s.then){if(!h(s))return void s.then(n,o||(o=l.bind(null,r=new f,2)));s=s.v}r?l(r,1,s):r=s}catch(t){l(r||(r=new f),2,t)}}(),r}(a,function(t){return e(a[t])})}(t.required_action.submit_tool_outputs.tool_calls,function(t){var e=t.function.name;console.log("Requested function: ",e);var n=JSON.parse(t.function.arguments),i=function(i,s){try{var u=Promise.resolve(a[e](n,o,r)).then(function(e){d.push({tool_call_id:t.id,output:JSON.stringify(e)})})}catch(t){return s(t)}return u&&u.then?u.then(void 0,s):u}(0,function(e){d.push({tool_call_id:t.id,output:JSON.stringify(e)})});if(i&&i.then)return i.then(function(){})});return Promise.resolve(v&&v.then?v.then(i):i())}catch(t){return Promise.reject(t)}}(i,r,n,t,e)).then(function(e){return console.log("getting latest message "),Promise.resolve(o(t,5)).then(function(t){u=t})});u=[{runStatus:i.status}]}();return a&&a.then?a.then(function(){}):void 0}();return a&&a.then?a.then(function(){return u}):u})})}catch(t){return Promise.reject(t)}}(t,r,n))},u=t.client,a=t.thread,d=function(t,n){try{var r=Promise.resolve(u.beta.threads.messages.create(a.id,{role:"user",content:e})).then(function(){})}catch(t){return n(t)}return r&&r.then?r.then(void 0,n):r}(0,function(t){throw console.log(t),new Error("Request failed on adding user message to thread.")});return Promise.resolve(d&&d.then?d.then(i):i())}catch(t){return Promise.reject(t)}},t.setupAssistant=function(t){try{var e=new r.default({apiKey:t.credentials.key,dangerouslyAllowBrowser:!0}),n={provider:"openai",client:e,assistant:null,thread:null,threadid:null,specs:t.domainTools,appEnv:null,config:t};return Promise.resolve(function(t,e){try{var n=function(){return u},r=e.assistantName,o=e.assistantid,i=e.domainTools,s={name:r,instructions:e.instructions,model:e.model};null!=i.tools&&(s.tools=i.tools);var u=null;console.log(o);var a="0"===o||null==o,c=function(){if(0==a)return Promise.resolve(t.beta.assistants.retrieve(o)).then(function(t){u=t});var e=function(){if(null!=r)return Promise.resolve(t.beta.assistants.list({order:"desc",limit:"100"})).then(function(e){u=e.data.find(function(t){if(t.name===r)return t});var n=function(){if(null==u)return Promise.resolve(t.beta.assistants.create(s)).then(function(t){u=t})}();if(n&&n.then)return n.then(function(){})})}();return e&&e.then?e.then(function(){}):void 0}();return Promise.resolve(c&&c.then?c.then(n):n())}catch(t){return Promise.reject(t)}}(e,t)).then(function(r){return n.assistant=r,Promise.resolve(function(t,e){try{var n=function(t){return o},r=e.threadid,o=null,i=function(e,n){try{var i=Promise.resolve("0"===r?t.beta.threads.create({metadata:{assistantName:assistant.name}}):t.beta.threads.retrieve(r)).then(function(t){o=t})}catch(t){return n(t)}return i&&i.then?i.then(void 0,n):i}(0,function(t){throw console.log(t),console.log(t.status),new Error("Error status "+t.status+". Unable to retrieve the thread "+r+". see console for details.")});return Promise.resolve(i&&i.then?i.then(n):n())}catch(t){return Promise.reject(t)}}(e,t)).then(function(t){return n.thread=t,n.threadid=n.thread.id,n})})}catch(t){return Promise.reject(t)}},t.uploadFile=function(t,e,n){try{var r=n.client,o=n.assistant;return Promise.resolve(r.files.create({file:t,purpose:e})).then(function(t){console.log(".......................",t);var e=[].concat(o.file_ids);e.push(t.id),console.log(e);var i=function(t,i){try{var s=Promise.resolve(r.beta.assistants.update(o.id,{file_ids:e})).then(function(t){n.assistant=t,console.log(".......................",t)})}catch(t){return i(t)}return s&&s.then?s.then(void 0,i):s}(0,function(t){console.log(t)});return i&&i.then?i.then(function(){return e}):e})}catch(t){return Promise.reject(t)}}});
//# sourceMappingURL=index.umd.js.map
