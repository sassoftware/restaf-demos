!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("openai"),require("@sassoftware/restafedit"),require("@sassoftware/restaflib"),require("@sassoftware/restaf")):"function"==typeof define&&define.amd?define(["exports","openai","@sassoftware/restafedit","@sassoftware/restaflib","@sassoftware/restaf"],t):t((e||self).assistantjs={},e.openai,e.restafedit,e.restaflib,e.restaf)}(this,function(e,t,r,n,s){function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=/*#__PURE__*/i(t),a=/*#__PURE__*/i(r),u=/*#__PURE__*/i(n),l=/*#__PURE__*/i(s);function c(e){var t=[];return e.map(function(e){var r=e.line.replace(/(\r\n|\n|\r)/gm,"");t.push(0===r.length?"   ":r)}),t}function f(e,t){var r={},n="cas"===t?"caslib":"libref",s=e.split(".");return 2===s.length?(r[n]=s[0],r.name=s[1],r):null}function h(e){if(0===e.length)return"";var t=Object.keys(e[0]).join(",")+"\n",r="";return e.map(function(e){var t="",n="";Object.values(e).map(function(e){t=t+n+function(e){return"."==e||null==e?"":"string"==typeof e?(e=e.replace(/"/g,'""')).trim():e.toString()}(e),n=","}),r=r+t+"\n"}),t+r}var d=function(e,t){return Promise.resolve(function(e,t){try{var r=e.table,n=e.limit,s=e.format,i=e.where,o=e.csv,u=t.source,l=t.sessionID;o=null!=o&&o,console.log(e);var c=f(r,u);return null===c?Promise.resolve("Table must be specified in the form casuser.cars or sashelp.cars"):Promise.resolve(a.default.setup(t.logonPayload,{source:u,table:c,casServerName:t.casServerName,computeContext:t.computeContext,initialFetch:{qs:{start:0,limit:null==n?2:n,format:null!=s&&s,where:null==i?"":i}}},l)).then(function(e){var t={},r=function(r,n){try{var s=Promise.resolve(a.default.scrollTable("first",e)).then(function(){return Promise.resolve(a.default.getTableSummary(e)).then(function(r){t={table:c,tableSummary:r,columns:e.state.columns,data:!1===o?e.state.data:h(e.state.data)}})})}catch(e){return n(e)}return s&&s.then?s.then(void 0,n):s}(0,function(e){console.log(e),t={error:e}});return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}(e,t)).then(JSON.stringify)},m=function(e){try{var t=e.keywords;switch(e.format){case"html":var r="<ul>";return t.split(",").forEach(function(e){r+="<li>"+e+"</li>"}),r+="</ul>",Promise.resolve(r);case"array":return Promise.resolve(t.split(","));case"object":var n={};return t.split(",").forEach(function(e,t){n["key"+t]=e}),Promise.resolve(n);default:return Promise.resolve(e)}}catch(e){return Promise.reject(e)}},p=function(e,t){try{var r=e.src,n=t.store,s=t.session;return"cas"===t.source?Promise.resolve(S(n,s,r,{},!0)).then(function(e){return JSON.stringify(e.results)}):Promise.resolve(w(n,s,r)).then(function(e){return Promise.resolve(j(n,e,"log")).then(c)})}catch(e){return Promise.reject(e)}},v=function(e,t){try{return Promise.resolve(idescribeTable(e,t)).then(function(e){return JSON.stringify({table:e.table,data:e.data})})}catch(e){return Promise.reject(e)}},b=function(e,t){try{var r=t.source,n=f(e.table,r);return null===n?Promise.resolve("Table must be specified in the form casuser.cars or sashelp.cars"):Promise.resolve(_getTableColumns(r,n,t)).then(function(e){return JSON.stringify(e)})}catch(e){return Promise.reject(e)}},y=function(e,t){try{var r=e.limit;return Promise.resolve(_getTableList(e.library,t,{qs:{limit:null==r?10:r,start:0}})).then(JSON.stringify)}catch(e){return Promise.reject(e)}},g=function(e,t){try{return Promise.resolve(T(t)).then(JSON.stringify)}catch(e){return Promise.reject(e)}},P=function(e,t){try{var r=e.resource,n=e.limit,s=t.store;return n=null==n?10:n,!1===["files","folders","reports"].includes(r.toLowerCase())?Promise.resolve('{Error: "resource '+r+' is not supported at this time"}'):Promise.resolve(s.addServices(r)).then(function(e){var t={qs:{limit:n,start:0}};return Promise.resolve(s.apiCall(e[r].links(r),t)).then(function(e){var t=e.itemsList().toJS();return JSON.stringify(t)})})}catch(e){return Promise.reject(e)}},S=u.default.caslRun,w=u.default.computeRun,j=u.default.computeResults,T=a.default.getLibraryList,A={name:"_getData",description:"Fetch data from a  table like casuser.cars.\n                To limit the number of rows, specify the limit parameter.\n                If format is true, then the data will be formatted.\n                Use standard where clause to filter the data.\n                To return data in csv format, specify csv = true. Default is false.",parameters:{properties:{table:{type:"string",description:"The table to setup. The form of the table is casuser.cars"},limit:{type:"integer",description:"Fetch only the specified number of rows"},format:{type:"boolean",description:"Format the string - true or false"},where:{type:"string",description:'A where clause like Make eq "Audi"'},csv:{type:"boolean",description:"Return data in csv format - true or false"}},type:"object",required:["table"]}},_={name:"_listSASObjects",description:"list SAS resources like reports, files, folders. Specify the limit parameter to limit the number of items returned",parameters:{properties:{resource:{type:"string",description:"The objecttable to setup. The form of the table is casuser.cars"},limit:{type:"integer",description:"Get this many items"}},type:"object",required:["resource","limit"]}},k={name:"_listSASDataLib",description:"list available SAS libs, calibs, librefs. A example would be list libs. If limit is not is specified, then the function will return the first 10 libs",parameters:{properties:{limit:{type:"integer",description:"Return only this many libs. If not specified, then return 10 libs."}},type:"object"}},O={name:"_listSASTables",description:"for a given library, lib , caslibs get the list available tables(ex: list tables for Samples)",parameters:{properties:{library:{type:"string",description:"A SAS library like casuser, sashelp, samples"},limit:{type:"integer",description:"Return only this many tables. If not specified, then return 10 tables."}},type:"object",required:["library","limit"]}},q={name:"_listColumns",description:"Get schema or columns for specified table. Table is of the form sashelp.cars",parameters:{properties:{table:{type:"string",description:"A table like sashelp.cars"}},type:"object",required:["table"]}},N={name:"_describeTable",description:"Describe the table like sashelp.cars . return information on the table like columns, types, keys. Optionally format the data",parameters:{properties:{table:{type:"string",description:"A table like sashelp.cars"},format:{type:"boolean",description:"If true then format the data"}},type:"object",required:["table"]}},D={name:"_runSAS",description:"run the specified file. The file is a path to the sas program",parameters:{properties:{file:{type:"string",description:"this is the file to run"}},type:"object",required:["file"]}},I={name:"_keywords",description:"format a comma-separated keywords like a,b,c into html, array, object",parameters:{properties:{keywords:{type:"string",description:"A comma-separated list of keywords like a,b,c"},format:{type:"string",enum:["html","array","object"],description:"Format the string"}},type:"object",required:["keywords","format"]}};function R(e,t){return"openai"===t?{listAssistants:e.beta.assistants.list.bind(null),getAssistant:e.beta.assistants.retrieve,createAssistant:e.beta.assistants.create,listMessages:e.beta.assistants.listMessages,createThread:e.beta.threads.createThread,getThread:e.beta.threads.retrieveThread,getRun:null,submitToolOutputsToRun:e.beta.assistants.submitToolOutputs}:"azureai"===t?{listAssistants:e.listAssistants,getAssistant:e.getAssistant,createAssistant:e.createAssistant,listMessages:e.listMessages,createThread:e.createThread,getThread:e.getThread,getRun:e.getRun,submitToolOutputsToRun:e.submitToolOutputsToRun}:void 0}var L=function(e,t){try{return Promise.resolve(e.client.beta.threads.messages.list(e.thread.id,{limit:t})).then(function(e){for(var t=[],r=e.data,n=0;n<e.data.length;n++){var s=r[n].content[0];if("assistant"!==r[n].role)break;t.push({id:r[n].id,role:r[n].role,type:s.type,content:s[s.type].value})}return t.length>1&&(t=t.reverse()),t})}catch(e){return Promise.reject(e)}};function x(e,t,r){if(!e.s){if(r instanceof C){if(!r.s)return void(r.o=x.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(x.bind(null,e,t),x.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var J=function(e,t,r){try{var n=r.client,s=null,i=null,o=function(e,t){var r;do{var n=e();if(n&&n.then){if(!E(n)){r=!0;break}n=n.v}var s=t();if(E(s)&&(s=s.v),!s)return n}while(!s.then);var i=new C,o=x.bind(null,i,2);return(r?n.then(a):s.then(u)).then(void 0,o),i;function a(r){for(n=r;E(s=t())&&(s=s.v),s;){if(s.then)return void s.then(u).then(void 0,o);if((n=e())&&n.then){if(!E(n))return void n.then(a).then(void 0,o);n=n.v}}x(i,1,n)}function u(r){if(r){do{if((n=e())&&n.then){if(!E(n))return void n.then(a).then(void 0,o);n=n.v}if(E(r=t())&&(r=r.v),!r)return void x(i,1,n)}while(!r.then);r.then(u).then(void 0,o)}else x(i,1,n)}}(function(){return Promise.resolve(n.beta.threads.runs.retrieve(e.id,t.id)).then(function(e){i=e,console.log("-------------------",i.status);var t=function(){if("queued"===i.status||"in_progress"===i.status||"cancelling"===i.status)return Promise.resolve(new Promise(function(e){return setTimeout(e,2e3)})).then(function(){console.log("waited 2000 ms")});s=i.status}();if(t&&t.then)return t.then(function(){})})},function(){return null===s});return Promise.resolve(o&&o.then?o.then(function(){return i}):i)}catch(e){return Promise.reject(e)}};const C=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,s=this.s;if(s){const e=1&s?t:r;if(e){try{x(n,1,e(this.v))}catch(e){x(n,2,e)}return n}return this}return this.o=function(e){try{const s=e.v;1&e.s?x(n,1,t?t(s):s):r?x(n,1,r(s)):x(n,2,s)}catch(e){x(n,2,e)}},n},e}();function E(e){return e instanceof C&&1&e.s}const M="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function F(e,t,r){if(!e.s){if(r instanceof Y){if(!r.s)return void(r.o=F.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(F.bind(null,e,t),F.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var Y=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,s=this.s;if(s){var i=1&s?t:r;if(i){try{F(n,1,i(this.v))}catch(e){F(n,2,e)}return n}return this}return this.o=function(e){try{var s=e.v;1&e.s?F(n,1,t?t(s):s):r?F(n,1,r(s)):F(n,2,s)}catch(e){F(n,2,e)}},n},e}();function G(e){return e instanceof Y&&1&e.s}e.closeAssistant=function(e,t){try{return console.log("in closeAssistant"),Promise.resolve(!0)}catch(e){return Promise.reject(e)}},e.getLatestMessage=L,e.getMessages=function(e,t){try{return Promise.resolve(e.client.beta.threads.messages.list(e.thread.id,{limit:t})).then(function(e){return e.data.map(function(e){var t=e.content[0];return{id:e.id,role:e.role,type:t.type,content:t[t.type].value}})})}catch(e){return Promise.reject(e)}},e.runAssistant=function(e,t,r,n){try{var s=function(t){return Promise.resolve(function(e,t,r){try{var n=e.thread;return Promise.resolve(e.client.beta.threads.runs.create(n.id,{assistant_id:e.assistant.id,instructions:null!=r?r:""})).then(function(r){return Promise.resolve(J(n,r,e)).then(function(s){var i,o=function(){if("completed"===s.status)return Promise.resolve(L(e,5)).then(function(e){i=e});var o=function(){if("requires_action"===s.status)return Promise.resolve(function(e,t,r,n,s){try{var i=function(){return console.log("Adding output to messages"),Promise.resolve(o.beta.threads.runs.submitToolOutputs(t.id,r.id,{tool_outputs:u})).then(function(e){return Promise.resolve(J(t,e,n))})},o=n.client,a=n.specs.functionList,u=[],l=function(e,t,r){if("function"==typeof e[M]){var n,s,i,o=e[M]();if(function e(r){try{for(;!(n=o.next()).done;)if((r=t(n.value))&&r.then){if(!G(r))return void r.then(e,i||(i=F.bind(null,s=new Y,2)));r=r.v}s?F(s,1,r):s=r}catch(e){F(s||(s=new Y),2,e)}}(),o.return){var a=function(e){try{n.done||o.return()}catch(e){}return e};if(s&&s.then)return s.then(a,function(e){throw a(e)});a()}return s}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],l=0;l<e.length;l++)u.push(e[l]);return function(e,t,r){var n,s,i=-1;return function r(o){try{for(;++i<e.length;)if((o=t(i))&&o.then){if(!G(o))return void o.then(r,s||(s=F.bind(null,n=new Y,2)));o=o.v}n?F(n,1,o):n=o}catch(e){F(n||(n=new Y),2,e)}}(),n}(u,function(e){return t(u[e])})}(e.required_action.submit_tool_outputs.tool_calls,function(e){var t=e.function.name;console.log("Requested function: ",t);var r=JSON.parse(e.function.arguments),i=function(i,o){try{var l=Promise.resolve(a[t](r,s,n)).then(function(t){u.push({tool_call_id:e.id,output:JSON.stringify(t)})})}catch(e){return o(e)}return l&&l.then?l.then(void 0,o):l}(0,function(t){u.push({tool_call_id:e.id,output:JSON.stringify(t)})});if(i&&i.then)return i.then(function(){})});return Promise.resolve(l&&l.then?l.then(i):i())}catch(e){return Promise.reject(e)}}(s,n,r,e,t)).then(function(t){return console.log("getting latest message "),Promise.resolve(L(e,5)).then(function(e){i=e})});i=[{runStatus:s.status}]}();return o&&o.then?o.then(function(){}):void 0}();return o&&o.then?o.then(function(){return i}):i})})}catch(e){return Promise.reject(e)}}(e,n,r))},i=e.client,o=e.thread,a=function(e,r){try{var n=Promise.resolve(i.beta.threads.messages.create(o.id,{role:"user",content:t})).then(function(){})}catch(e){return r(e)}return n&&n.then?n.then(void 0,r):n}(0,function(e){throw console.log(e),new Error("Request failed on adding user message to thread.")});return Promise.resolve(a&&a.then?a.then(s):s())}catch(e){return Promise.reject(e)}},e.setupAssistant=function(e){try{var t=new o.default({apiKey:e.credentials.key,dangerouslyAllowBrowser:!0}),r=(a=[_,k,O,q,N,A,D,I],(c=[{type:"retrieval"}]).push({type:"retrieval"}),a.forEach(function(e){var t={type:"function",function:Object.assign({},e)};c.push(t)}),{specs:a,tools:c,functionList:{_getData:v,_listSASObjects:P,_listSASTables:y,_listColumns:b,_listSASDataLib:g,_runSAS:p,_keywords:m,_describeTable:d},instructions:"\n You are a Assistant designed for SAS users. You can help SAS users with their SAS related questions and provide information\n  on topics like libraries, reports, tables. You can also fetch data from tables and run SAS programs. You can also help answer questions about the \n  data that has been returned from previous queries.\n\n  If the response from a tool is of the form [{a:1,b:2},{a:1,b:3}] format the table as a html table element like this\n  '<table>\n     <tr>\n       <th>a</th> \n      <th>b</th>\n     </tr>\n    <tr>\n    <td>1</td>\n    <td>2</td>\n    </tr>\n    <tr>\n   <td>2</td>\n   <td>3</td>\n   </tr>\n   </table>' \n  \n  if the response from a tool is of the form [1,2,3] then return the data as a html unodered list to the user.\n  You can also allow users to attach files to the assistant. \n\n  "}),n=e.domainTools.tools.concat(r.tools),s=Object.assign(e.domainTools.functionList,r.functionList),i={provider:e.provider,model:e.model,assistant:null,thread:null,client:t,assistantName:e.assistantName,assistantid:e.assistantid,threadid:"0",domainSpecs:{tools:n,functionList:s},instructions:e.instructions?e.instructions+r.instructions:r.instructions,appEnv:null,api:R(t,e.provider)};return Promise.resolve(function(e){try{var t={host:null,logonPayload:null,store:null,source:"none",currentSource:r,session:null,servers:null,serverName:null,casServerName:null,sessionID:null,compute:{},cas:{},userData:null};if(null==e)return Promise.resolve(t);if("none"==e.source)return t.userData=e.userData,Promise.resolve(t);var r=e.source,n=e.logonPayload;t.host=n.host;var s=r.split(",")[0],i=l.default.initStore({casProxy:!0});return Promise.resolve(i.logon(n)).then(function(){function e(){function e(){return console.log(t),t}var n=function(){if(r.indexOf("compute")>0)return t.compute={servers:null},Promise.resolve(u.default.computeSetup(i)).then(function(e){return Promise.resolve(i.apiCall(t.session.links("self"))).then(function(r){t.compute.sessionID=r.items("id"),"compute"===s&&(t.source="compute",t.session=e,t.servers=null,t.serverName=null,t.sessionID=t.compute.sessionID)})})}();return n&&n.then?n.then(e):e()}t.host=n.host,t.logonPayload=n,t.store=i;var o=function(){if(r.indexOf("cas")>=0)return Promise.resolve(u.default.casSetup(i,null)).then(function(e){var r=e.session,n=e.servers,o=r.links("execute","link","server");return t.cas={session:r,servers:n,casServerName:o},Promise.resolve(i.apiCall(r.links("self"))).then(function(e){t.cas.sessionID=e.items("id"),"cas"===s&&(t.source="cas",t.session=r,t.servers=n,t.serverName=o,t.casServerName=o,t.sessionID=t.cas.sessionID)})})}();return o&&o.then?o.then(e):e()})}catch(e){return Promise.reject(e)}}(e.viyaConfig)).then(function(r){return i.appEnv=r,Promise.resolve(function(e,t){try{var r=function(){return t.assistantid=a.id,t.assistant=a,a},n=t.assistantName,s=t.assistantid,i=t.api,o={name:n,instructions:t.instructions,model:t.model,tools:t.domainSpecs.tools},a=null;console.log(s);var u="0"===s||null==s,l=function(){if(0==u)return Promise.resolve(e.beta.assistants.retrieve(s)).then(function(e){a=e});var t=function(){if(null!=n)return Promise.resolve(i.listAssistants({order:"desc",limit:"100"})).then(function(e){a=e.data.find(function(e){if(e.name===n)return e});var t=function(){if(null==a)return Promise.resolve(i.createAssistant(o)).then(function(e){a=e})}();if(t&&t.then)return t.then(function(){})})}();return t&&t.then?t.then(function(){}):void 0}();return Promise.resolve(l&&l.then?l.then(r):r())}catch(e){return Promise.reject(e)}}(t,i)).then(function(r){return i.assistant=r,Promise.resolve(function(e,t){try{var r=function(e){return n},n=null,s=function(r,s){try{var i=Promise.resolve("0"===t||null==t?e.beta.threads.create():e.beta.threads.retrieve(t)).then(function(e){n=e})}catch(e){return s(e)}return i&&i.then?i.then(void 0,s):i}(0,function(e){throw console.log(e),console.log(e.status),new Error("Error status "+e.status+". Unable to retrieve the thread "+t+". see console for details.")});return Promise.resolve(s&&s.then?s.then(r):r())}catch(e){return Promise.reject(e)}}(t,e.threadid)).then(function(e){return i.thread=e,i.threadid=i.thread.id,i})})})}catch(e){return Promise.reject(e)}var a,c},e.uploadFile=function(e,t,r){try{var n=r.client,s=r.assistant;return Promise.resolve(n.files.create({file:e,purpose:t})).then(function(e){console.log(".......................",e);var t=[].concat(s.file_ids);t.push(e.id),console.log(t);var i=function(e,i){try{var o=Promise.resolve(n.beta.assistants.update(s.id,{file_ids:t})).then(function(e){r.assistant=e,console.log(".......................",e)})}catch(e){return i(e)}return o&&o.then?o.then(void 0,i):o}(0,function(e){console.log(e)});return i&&i.then?i.then(function(){return t}):t})}catch(e){return Promise.reject(e)}}});
//# sourceMappingURL=index.umd.js.map
