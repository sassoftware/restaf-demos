!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("openai"),require("@azure/openai")):"function"==typeof define&&define.amd?define(["exports","openai","@azure/openai"],t):t((e||self).assistantjs={},e.openai,e.openai)}(this,function(e,t,n){function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=/*#__PURE__*/r(t),i=function(e,t){try{return Promise.resolve(e.client.beta.threads.messages.list(e.thread.id,{limit:t})).then(function(e){for(var t=[],n=e.data,r=0;r<e.data.length;r++){var o=n[r].content[0];if("assistant"!==n[r].role)break;t.push({id:n[r].id,role:n[r].role,type:o.type,content:o[o.type].value})}return t.length>1&&(t=t.reverse()),t})}catch(e){return Promise.reject(e)}};function s(e,t,n){if(!e.s){if(n instanceof a){if(!n.s)return void(n.o=s.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(s.bind(null,e,t),s.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var u=function(e,t,n){try{var r=function(){return u},o=n.client,i=null,u=null,l=function(e,t){var n;do{var r=e();if(r&&r.then){if(!c(r)){n=!0;break}r=r.v}var o=t();if(c(o)&&(o=o.v),!o)return r}while(!o.then);var i=new a,u=s.bind(null,i,2);return(n?r.then(l):o.then(f)).then(void 0,u),i;function l(n){for(r=n;c(o=t())&&(o=o.v),o;){if(o.then)return void o.then(f).then(void 0,u);if((r=e())&&r.then){if(!c(r))return void r.then(l).then(void 0,u);r=r.v}}s(i,1,r)}function f(n){if(n){do{if((r=e())&&r.then){if(!c(r))return void r.then(l).then(void 0,u);r=r.v}if(c(n=t())&&(n=n.v),!n)return void s(i,1,r)}while(!n.then);n.then(f).then(void 0,u)}else s(i,1,r)}}(function(){return Promise.resolve(o.beta.threads.runs.retrieve(e.id,t.id)).then(function(e){u=e,console.log("-------------------",u.status);var t=function(){if("queued"===u.status||"in_progress"===u.status||"cancelling"===u.status)return Promise.resolve(new Promise(function(e){return setTimeout(e,2e3)})).then(function(){console.log("waited 2000 ms")});i=u.status}();if(t&&t.then)return t.then(function(){})})},function(){return null===i});return Promise.resolve(l&&l.then?l.then(r):r())}catch(e){return Promise.reject(e)}};const a=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{s(r,1,e(this.v))}catch(e){s(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?s(r,1,t?t(o):o):n?s(r,1,n(o)):s(r,2,o)}catch(e){s(r,2,e)}},r},e}();function c(e){return e instanceof a&&1&e.s}var l="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function f(e,t,n){if(!e.s){if(n instanceof h){if(!n.s)return void(n.o=f.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(f.bind(null,e,t),f.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var h=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{f(r,1,i(this.v))}catch(e){f(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?f(r,1,t?t(o):o):n?f(r,1,n(o)):f(r,2,o)}catch(e){f(r,2,e)}},r},e}();function d(e){return e instanceof h&&1&e.s}e.closeAssistant=function(e,t){try{return console.log("in closeAssistant"),Promise.resolve(!0)}catch(e){return Promise.reject(e)}},e.getLatestMessage=i,e.getMessages=function(e,t){try{return Promise.resolve(e.client.beta.threads.messages.list(e.thread.id,{limit:t})).then(function(e){return e.data.map(function(e){var t=e.content[0];return{id:e.id,role:e.role,type:t.type,content:t[t.type].value}})})}catch(e){return Promise.reject(e)}},e.runAssistant=function(e,t,n,r){try{var o=e.client,s=e.thread;return Promise.resolve(function(a,c){try{var v=Promise.resolve(o.beta.threads.messages.create(s.id,{role:"user",content:t})).then(function(t){return Promise.resolve(function(e,t,n){try{var r=e.thread;return Promise.resolve(e.client.beta.threads.runs.create(r.id,{assistant_id:e.assistant.id,instructions:null!=n?n:""})).then(function(n){return Promise.resolve(u(r,n,e)).then(function(o){var s,a=function(){if("completed"===o.status)return Promise.resolve(i(e,5)).then(function(e){s=e});var a=function(){if("requires_action"===o.status)return Promise.resolve(function(e,t,n,r,o){try{var i=function(){return Promise.resolve(s.beta.threads.runs.submitToolOutputs(t.id,n.id,{tool_outputs:c})).then(function(e){return Promise.resolve(u(t,e,r))})},s=r.client,a=r.specs.functionList,c=[],v=function(e,t,n){if("function"==typeof e[l]){var r,o,i,s=e[l]();if(function e(n){try{for(;!(r=s.next()).done;)if((n=t(r.value))&&n.then){if(!d(n))return void n.then(e,i||(i=f.bind(null,o=new h,2)));n=n.v}o?f(o,1,n):o=n}catch(e){f(o||(o=new h),2,e)}}(),s.return){var u=function(e){try{r.done||s.return()}catch(e){}return e};if(o&&o.then)return o.then(u,function(e){throw u(e)});u()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var a=[],c=0;c<e.length;c++)a.push(e[c]);return function(e,t,n){var r,o,i=-1;return function n(s){try{for(;++i<e.length;)if((s=t(i))&&s.then){if(!d(s))return void s.then(n,o||(o=f.bind(null,r=new h,2)));s=s.v}r?f(r,1,s):r=s}catch(e){f(r||(r=new h),2,e)}}(),r}(a,function(e){return t(a[e])})}(e.required_action.submit_tool_outputs.tool_calls,function(e){var t=e.function.name;console.log("Requested function: ",t);var n=JSON.parse(e.function.arguments);return Promise.resolve(a[t](n,o,r)).then(function(t){c.push({tool_call_id:e.id,output:JSON.stringify(t)})})});return Promise.resolve(v&&v.then?v.then(i):i())}catch(e){return Promise.reject(e)}}(o,r,n,e,t)).then(function(t){return Promise.resolve(i(e,5)).then(function(e){s=e})});s=[{runStatus:o.status}]}();return a&&a.then?a.then(function(){}):void 0}();return a&&a.then?a.then(function(){return s}):s})})}catch(e){return Promise.reject(e)}}(e,r,n))})}catch(e){return c(e)}return v&&v.then?v.then(void 0,c):v}(0,function(e){throw console.log("status = "+e.status+". Unable to add the prompt to the thread"),console.log(e),new Error("Unable to add the prompt to the thread. See console for more details")}))}catch(e){return Promise.reject(e)}},e.setupAssistant=function(e){try{var t=e.provider,r=e.credentials,i=r.openaiKey,s=r.azureaiKey,u=r.azureaiEndpoint,a=null;if("openai"===t){if(null==i)throw new Error("Missing OpenAI API Key");a=new o.default({apiKey:i,dangerouslyAllowBrowser:!0})}else{if("azureai"!==t)throw new Error("Invalid provider. Must be openai or azureai.");if(null==s)throw new Error("Missing Azure API Key");if(null==u)throw new Error("Missing Azure Endpoint");a=new n.OpenAIClient(endpoint,new n.OpenAIKeyCredential(s)),console.log(Object.keys(a))}var c={client:a,assistant:null,thread:null,threadid:null,specs:e.domainTools,appEnv:null,config:e};return Promise.resolve(function(e,t){try{var n=function(){return u},r=t.assistantName,o=t.assistantid,i=t.domainTools,s={name:r,instructions:t.instructions,model:t.model};null!=i.tools&&(s.tools=i.tools);var u=null;console.log(o);var a="0"!==o?Promise.resolve(e.beta.assistants.retrieve(o)).then(function(e){u=e}):Promise.resolve(e.beta.assistants.list({order:"desc",limit:"100"})).then(function(t){u=t.data.find(function(e){if(e.name===r)return e});var n=function(){if(null==u)return Promise.resolve(e.beta.assistants.create(s)).then(function(e){u=e})}();if(n&&n.then)return n.then(function(){})});return Promise.resolve(a&&a.then?a.then(n):n())}catch(e){return Promise.reject(e)}}(a,e)).then(function(t){return c.assistant=t,Promise.resolve(function(e,t){try{var n=function(e){return o},r=t.threadid,o=null,i=function(t,n){try{var i=Promise.resolve("0"===r?e.beta.threads.create({metadata:{assistantName:assistant.name}}):e.beta.threads.retrieve(r)).then(function(e){o=e})}catch(e){return n(e)}return i&&i.then?i.then(void 0,n):i}(0,function(e){throw console.log(e),console.log(e.status),new Error("Error status "+e.status+". Unable to retrieve the thread "+r+". see console for details.")});return Promise.resolve(i&&i.then?i.then(n):n())}catch(e){return Promise.reject(e)}}(a,e)).then(function(e){return c.thread=e,c.threadid=c.thread.id,c})})}catch(e){return Promise.reject(e)}}});
//# sourceMappingURL=index.umd.js.map
