import e from"openai";import{OpenAIClient as t,OpenAIKeyCredential as n}from"@azure/openai";import r from"@sassoftware/restaf";import o from"@sassoftware/restaflib";var s=function(e,t,n,r){try{var o=function(){function t(){return{thread:s,assistant:n}}var r=function(){if(null==s)return console.log("Creating new thread"),Promise.resolve(e.beta.threads.create({metadata:{assistanceName:n.name}})).then(function(t){return s=t,Promise.resolve(e.beta.assistants.update(n.id,{metadata:{thread_id:s.id,lastRunId:"0"}})).then(function(e){n=e})})}();return r&&r.then?r.then(t):t()},s=null,i=function(){if(!0===r&&"0"!=t){var n=function(n,r){try{var o=Promise.resolve(e.beta.threads.retrieve(t)).then(function(e){s=e})}catch(e){return r(e)}return o&&o.then?o.then(void 0,r):o}(0,function(e){console.log(e),console.log(e.status),console.log("Error status "+e.status+". Unable to retrieve the thread "+thread_id)});if(n&&n.then)return n.then(function(){})}}();return Promise.resolve(i&&i.then?i.then(o):o())}catch(e){return Promise.reject(e)}},i=function(i){try{var a=i.provider,u=i.assistantName,c=i.credentials,l="openai"===a?c.openaiKey:c.azureaiKey,h=c.azureaiEndpoint,d="openai"===a?new e({apiKey:l}):new t(h,new n(l));return Promise.resolve(d.beta.assistants.list({order:"desc",limit:"100"})).then(function(e){var t=e.data.find(function(e){if(e.name===u)return e});return Promise.resolve(null==t?function(e,t){try{var n=t.assistantName,r=t.specs,o=t.reuseThread;return Promise.resolve(e.beta.assistants.create({name:n,instructions:t.instructions,model:t.model,tools:r.tools,metadata:{thread_id:"0",lastRunId:"0"}})).then(function(i){return console.log("-----------------------------------"),console.log("New Assistant: ",n,i.id),Promise.resolve(s(e,t.threadid,i,o)).then(function(t){return console.log("Thread ID: ",t.thread.id),console.log("-----------------------------------"),{openai:e,assistant:t.assistant,thread:t.thread,threadid:t.thread.id,specs:r}})})}catch(e){return Promise.reject(e)}}(d,i):function(e,t,n){try{var r=n.reuseThread;console.log("Using Existing Assistant: ",t.name,t.id);var o=t.metadata.thread_id;return"0"!==n.threadid&&(o=n.threadid),console.log("Associated thread_id: ",o),Promise.resolve(s(e,o,t,r)).then(function(t){return{openai:e,assistant:t.assistant,thread:t.thread,threadid:t.thread.id,specs:n.specs}})}catch(e){return Promise.reject(e)}}(d,t,i)).then(function(e){return Promise.resolve(function(e,t){try{var n={host:null,logonPayload:null,store:null,session:null,servers:null,casServerName:null,source:e,sessionID:null};if("none"===e||null==e)return Promise.resolve(n);var s=r.initStore({casProxy:!0});return Promise.resolve(s.logon(t)).then(function(){function r(){return Promise.resolve(s.apiCall(n.session.links("self"))).then(function(e){return n.sessionID=e.items("id"),n})}n={host:host,logonPayload:t,store:s,source:e};var i="cas"===e?Promise.resolve(o.casSetup(s,null)).then(function(e){var t=e.session,r=e.servers;n.session=t,n.servers=r,n.casServerName=t.links("execute","link","server")}):Promise.resolve(o.computeSetup(s)).then(function(e){n.session=e,n.server=null});return i&&i.then?i.then(r):r()})}catch(e){return Promise.reject(e)}}(i.source)).then(function(t){return{gptControl:e,appEnv:t}})})})}catch(e){return Promise.reject(e)}},a=function(e,t,n){try{return Promise.resolve(e.beta.threads.messages.list(t.id,{limit:n})).then(function(e){var t=e.data[0].content[0];return t[t.type].value})}catch(e){return Promise.reject(e)}};function u(e,t,n){if(!e.s){if(n instanceof l){if(!n.s)return void(n.o=u.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(u.bind(null,e,t),u.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var c=function(e,t,n){try{var r=function(){return Promise.resolve(o.beta.assistants.update(s.id,{metadata:{thread_id:e.id,lastRunId:t.id}})).then(function(e){return n.assistant=e,a})},o=n.openai,s=n.assistant,i=null,a=null,c=function(e,t){var n;do{var r=e();if(r&&r.then){if(!h(r)){n=!0;break}r=r.v}var o=t();if(h(o)&&(o=o.v),!o)return r}while(!o.then);var s=new l,i=u.bind(null,s,2);return(n?r.then(a):o.then(c)).then(void 0,i),s;function a(n){for(r=n;h(o=t())&&(o=o.v),o;){if(o.then)return void o.then(c).then(void 0,i);if((r=e())&&r.then){if(!h(r))return void r.then(a).then(void 0,i);r=r.v}}u(s,1,r)}function c(n){if(n){do{if((r=e())&&r.then){if(!h(r))return void r.then(a).then(void 0,i);r=r.v}if(h(n=t())&&(n=n.v),!n)return void u(s,1,r)}while(!n.then);n.then(c).then(void 0,i)}else u(s,1,r)}}(function(){return Promise.resolve(o.beta.threads.runs.retrieve(e.id,t.id)).then(function(e){a=e,console.log("-------------------",a.status);var t=function(){if("queued"===a.status||"in_progress"===a.status||"cancelling"===a.status)return Promise.resolve(new Promise(function(e){return setTimeout(e,2e3)})).then(function(){});i=a.status}();if(t&&t.then)return t.then(function(){})})},function(){return null===i});return Promise.resolve(c&&c.then?c.then(r):r())}catch(e){return Promise.reject(e)}};const l=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,o=this.s;if(o){const e=1&o?t:n;if(e){try{u(r,1,e(this.v))}catch(e){u(r,2,e)}return r}return this}return this.o=function(e){try{const o=e.v;1&e.s?u(r,1,t?t(o):o):n?u(r,1,n(o)):u(r,2,o)}catch(e){u(r,2,e)}},r},e}();function h(e){return e instanceof l&&1&e.s}var d="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function f(e,t,n){if(!e.s){if(n instanceof v){if(!n.s)return void(n.o=f.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(f.bind(null,e,t),f.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var v=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var s=1&o?t:n;if(s){try{f(r,1,s(this.v))}catch(e){f(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?f(r,1,t?t(o):o):n?f(r,1,n(o)):f(r,2,o)}catch(e){f(r,2,e)}},r},e}();function m(e){return e instanceof v&&1&e.s}function p(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var P=function(e,t,n){try{var r=function(){return Promise.resolve(o.beta.threads.messages.create(i.id,{role:"user",content:e})).then(function(e){return Promise.resolve(o.beta.threads.runs.create(i.id,{assistant_id:s.id,instructions:"Help user use SAS Viya to accomplish a task\n                      Allow users to query for information from a Viya Server.\n                      Allow users to query the retrieved information"})).then(function(e){return u=e,Promise.resolve(c(i,u,t)).then(function(e){return"completed"===e.status?Promise.resolve(a(o,i,1)):"requires_action"===e.status?Promise.resolve(function(e,t,n,r,o){try{var s=function(){return Promise.resolve(i.beta.threads.runs.submitToolOutputs(t.id,n.id,{tool_outputs:u})).then(function(e){return Promise.resolve(c(t,e,r))})},i=r.openai,a=r.specs.functionList,u=[],l=function(e,t,n){if("function"==typeof e[d]){var r,o,s,i=e[d]();if(function e(n){try{for(;!(r=i.next()).done;)if((n=t(r.value))&&n.then){if(!m(n))return void n.then(e,s||(s=f.bind(null,o=new v,2)));n=n.v}o?f(o,1,n):o=n}catch(e){f(o||(o=new v),2,e)}}(),i.return){var a=function(e){try{r.done||i.return()}catch(e){}return e};if(o&&o.then)return o.then(a,function(e){throw a(e)});a()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<e.length;c++)u.push(e[c]);return function(e,t,n){var r,o,s=-1;return function n(i){try{for(;++s<e.length;)if((i=t(s))&&i.then){if(!m(i))return void i.then(n,o||(o=f.bind(null,r=new v,2)));i=i.v}r?f(r,1,i):r=i}catch(e){f(r||(r=new v),2,e)}}(),r}(u,function(e){return t(u[e])})}(e.required_action.submit_tool_outputs.tool_calls,function(e){var t=e.function.name;console.log("Requested function: ",t);var n=JSON.parse(e.function.arguments);return Promise.resolve(a[t](n,o,r)).then(function(t){u.push({tool_call_id:e.id,output:JSON.stringify(t)})})});return Promise.resolve(l&&l.then?l.then(s):s())}catch(e){return Promise.reject(e)}}(e,i,u,t,n)).then(function(e){return Promise.resolve(a(o,i,1))}):{runStatus:e.status}})})})},o=t.openai,s=t.assistant,i=t.thread,u=null,l=p(function(){return Promise.resolve(o.beta.threads.messages.create(i.id,{role:"user",content:e})).then(function(e){})},function(e){console.log("status = "+e.status+". Unable to add the prompt to the thread"),console.log("will try to cancel the last run"),console.log(e);var n=function(){if(400!==e.status||"0"===s.metadata.lastRunId)return Promise.resolve(o.beta.threads.del(i.id)).then(function(){return Promise.resolve(o.beta.threads.create({metadata:{assistanceName:s.name,lastRunId:"0"}})).then(function(e){t.thread=i=e,console.log("Deleted old thread and created a new one")})});var n=p(function(){return Promise.resolve(o.beta.threads.runs.cancel(i.id,s.metadata.lastRunId)).then(function(e){return u=e,Promise.resolve(o.beta.assistants.update(s.id,{metadata:{thread_id:i.id,lastRunId:u.id}})).then(function(e){t.assistant=s=e,console.log("Cancelled the last run")})})},function(e){console.log("Unable to cancel the last run"),console.log(e)});return n&&n.then?n.then(function(){}):void 0}();return n&&n.then?n.then(function(){}):void 0});return Promise.resolve(l&&l.then?l.then(r):r())}catch(e){return Promise.reject(e)}},y=function(e,t){return Promise.resolve(!0)};export{y as closeAssistant,P as runAssistant,i as setupAssistant};
//# sourceMappingURL=index.module.js.map
