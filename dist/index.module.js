import e from"openai";import{AssistantsClient as t,AzureKeyCredential as n}from"@azure/openai-assistants";import r from"@sassoftware/restaf";import s from"@sassoftware/restaflib";import o from"@sassoftware/restafedit";function i(e){var t=[];return e.map(function(e){var n=e.line.replace(/(\r\n|\n|\r)/gm,"");t.push(0===n.length?"   ":n)}),t}function a(e,t){var n={},r="cas"===t?"caslib":"libref",s=(e=e.toLocaleLowerCase().replace(".sashdat","")).split(".");return s.length>=2?(n[r]=s[0].trim(),n.name=s[1].trim(),n):null}function l(e){if(0===e.length)return"";var t=Object.keys(e[0]).filter(function(e){return!("_rowIndex"===e||"_modified"===e)}).join(",")+"\n",n="";return e.map(function(e){var t,r="",s="";for(var o in e)"_rowIndex"!==o&&"_modified"!==o&&(r=r+s+("."==(t=e[o])||null==t?"":"string"==typeof t?(t=t.replace(/"/g,'""')).trim():t.toString()),s=",");n=n+r+"\n"}),t+n}function u(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var c=function(e,t){try{var n=e.limit,r=e.format,s=e.where,o=e.csv,i=t.source,c=t.sessionID,f=t.restafedit;o=null!=o&&o;var d=a(e.table,i);return null===d?Promise.resolve("Table must be specified in the form casuser.cars or sashelp.cars"):Promise.resolve(f.setup(t.logonPayload,{source:i,table:d,casServerName:t.casServerName,computeContext:t.computeContext,initialFetch:{qs:{start:0,limit:null==n?2:n,format:null!=r&&r,where:null==s?"":s}}},c)).then(function(e){var t={},n=u(function(){return Promise.resolve(f.scrollTable("first",e)).then(function(){return Promise.resolve(f.getTableSummary(e)).then(function(n){t={table:d,tableSummary:n,columns:e.state.columns,data:!1!==o?e.state.data:l(e.state.data)}})})},function(e){console.log(e),t={error:e}});return n&&n.then?n.then(function(){return t}):t})}catch(e){return Promise.reject(e)}},f=function(e,t){return Promise.resolve(c(e,t)).then(function(e){return JSON.stringify(e,null,4)})},d=function(e){try{var t=e.keywords,n=e.format;switch(console.log("keywords",t,n),n){case"html":var r="<ul>";return t.split(",").forEach(function(e){r+="<li>"+e+"</li>"}),r+="</ul>",Promise.resolve(r);case"array":return Promise.resolve(t.split(","));case"object":var s={};return t.split(",").forEach(function(e,t){s["key"+t]=e}),Promise.resolve(s);default:return Promise.resolve(e)}}catch(e){return Promise.reject(e)}},h=function(e,t,n){try{var r=e.program,s=t.store,o=t.session,a=t.restaflib;return Promise.resolve(u(function(){return"cas"===t.source?Promise.resolve(a.caslRun(s,o,r,{},!0)).then(function(e){return JSON.stringify(e.results,null,4)}):t?Promise.resolve(computeRun(s,o,src)).then(function(e){return Promise.resolve(a.computeResults(s,e,"log")).then(i)}):"Cannot run program without a session"},function(e){return console.log(e),"Error running program "+r}))}catch(e){return Promise.reject(e)}},m=function(e,t){return Promise.resolve(c(e,t)).then(function(e){return JSON.stringify({table:e.table,data:e.data},null,4)})},v=function(e,t){try{return null===a(e.table,t.source)?Promise.resolve("Table must be specified in the form casuser.cars or sashelp.cars"):Promise.resolve(t.restafedit.getTableList(library,t,p)).then(function(e){return JSON.stringify(e,null,4)})}catch(e){return Promise.reject(e)}},g=function(e,t){try{var n=e.limit;return Promise.resolve(t.restafedit.getTableList(e.library,t,{qs:{limit:null==n?10:n,start:0}})).then(function(e){return JSON.stringify(e,null,4)})}catch(e){return Promise.reject(e)}},b=function(e,t){try{var n=e.limit,r=e.start;return Promise.resolve(t.restafedit.getLibraryList(t,{qs:{limit:null==n?10:n,start:null==r?0:r}})).then(function(e){return JSON.stringify(e,null,4)})}catch(e){return Promise.reject(e)}},y=function(e,t){try{var n=e.resource,r=e.limit,s=t.store;return r=null==r?10:r,!1===["files","folders","reports"].includes(n.toLowerCase())?Promise.resolve("{Error: 'resource "+n+" is not supported at this time'}"):Promise.resolve(s.addServices(n)).then(function(e){var t={qs:{limit:r,start:0}};return Promise.resolve(s.apiCall(e[n].links(n),t)).then(function(e){var t=e.itemsList();return JSON.stringify(t,null,4)})})}catch(e){return Promise.reject(e)}},P=function(e,t,n){try{var r=e.metadata,s=t.store;return console.log("metadata",r),console.log(r),Promise.resolve(u(function(){return Promise.resolve(s.addServices("catalog")).then(function(e){var t=e.catalog,n={qs:{q:r}};return console.log("payload: ",n),Promise.resolve(s.apiCall(t.links("search"),n)).then(function(e){console.log(JSON.stringify(e.itemsList(),null,4));var t=function(e){var t={};return e.itemsList().size>0?e.itemsList().toJS().map(function(n){var r=e.items(n,"data").toJS();return t[n]=r,r}):t=null!=e.items("data")?e.items("data").toJS():{warning:"No data returned"},JSON.stringify(t,null,4)}(e);return t})})},function(e){return console.log(JSON.stringify(e)),"Error searching catalog"}))}catch(e){return Promise.reject(e)}},w={name:"_catalogSearch",description:"Search for the specified metadata in SAS Viya. \n      The metdata string is created from the user input using these rules:\n      parse the string from left to right and concatenate resulting search term into the metadata string\n      Use blanks to separate the search terms.\n      a. if the string has no ':' at the end of the string, then use it as a  search term \n      b. if the string of the format  keystring:string or keystring: string treat it as another search term.\n      c. The string AND is treated as a logical AND and a search term when it appears between two search terms.\n      d. The string OR is treated as a logical OR and a search term when it appears between two search terms.\n      e. if the string is of the format keystring: {string1, string2} then treat it as another search term.\n\n    Examples:\n    1. search sales  becomes sales\n    2. search name: xxx becomes name: xxx\n    3. search sales name: xxx becomes for: sales name: xxx\n    4. search name: {xxx, yyy} becomes name: {xxx, yyy}\n      \n      ",parameters:{properties:{metadata:{type:"string",description:"The metadata to return"}},type:"object",required:["metadata"]}},S={name:"_getData",description:"Fetch data from a  table like casuser.cars.\n                To limit the number of rows, specify the limit parameter.\n                If format is true, then the data will be formatted.\n                Use standard where clause to filter the data.\n                To return data in csv format, specify csv = true. Default is false.",parameters:{properties:{table:{type:"string",description:"The table to setup. The form of the table is casuser.cars"},limit:{type:"integer",description:"Fetch only the specified number of rows"},format:{type:"boolean",description:"Format the string - true or false"},where:{type:"string",description:'A where clause like Make eq "Audi"'},csv:{type:"boolean",description:"Return data in csv format - true or false"}},type:"object",required:["table"]}},A={name:"_listSASObjects",description:"list SAS resources like reports, files, folders. Specify the limit parameter to limit the number of items returned",parameters:{properties:{resource:{type:"string",description:"The objecttable to setup. The form of the table is casuser.cars"},limit:{type:"integer",description:"Get this many items"}},type:"object",required:["resource","limit"]}},T={name:"_listSASDataLib",description:"list available SAS libs, calibs, librefs or libraries.\n     This tool is the only one that can answer questions like this.\n\n     A example would be list libs. \n     If limit is not is specified, then the function \n     will return the first 10 libs.\n    ",parameters:{properties:{limit:{type:"integer",description:"Return only this many libs. If not specified, then return 10 libs."},source:{type:"string",description:"The source of the data. cas or compute",enum:["cas","compute"]}},type:"object"}},j={name:"_listSASTables",description:"for a given SAS library, lib, caslibs or libref get the list of available tables.\n    (ex: list tables for Samples)\n    Optionally let user specify the source as cas or compute.",parameters:{properties:{library:{type:"string",description:"A SAS library like casuser, sashelp, samples"},limit:{type:"integer",description:"Return only this many tables. If not specified, then return 10 tables."},source:{type:"string",description:"The source of the data. cas or compute",enum:["cas","compute"]}},type:"object",required:["library"]}},k={name:"_listColumns",description:"Get schema or columns for specified SAS  table. Table is of the form sashelp.cars",parameters:{properties:{table:{type:"string",description:"A table like sashelp.cars"}},type:"object",required:["table"]}},_={name:"_describeTable",description:"Describe the SAS table like sashelp.cars . return information on the table like columns, types, keys. Optionally format the data",parameters:{properties:{table:{type:"string",description:"A table like sashelp.cars"},format:{type:"boolean",description:"If true then format the data"}},type:"object",required:["table"]}},x={name:"_runSAS",description:"run the specified sas program",parameters:{properties:{program:{type:"string",description:"this is the program to run"}},type:"object",required:["program"]}},N={name:"_keywords",description:"format a comma-separated keywords like a,b,c into html, array, object",parameters:{properties:{keywords:{type:"string",description:"A comma-separated list of keywords like a,b,c"},format:{type:"string",enum:["html","array","object"],description:"Format the string"}},type:"object",required:["keywords","format"]}};function E(e,t){var n=e;return"openai"===t&&(n={listAssistants:function(e){return function(){var t=[].slice.call(arguments);return e.beta.assistants.list(t[0])}}(e),createAssistant:function(e){return function(){var t=[].slice.call(arguments);return e.beta.assistants.create(t[0])}}(e),getAssistant:function(e){return function(){var t=[].slice.call(arguments);return e.beta.assistants.retrieve(t[0])}}(e),deleteAssistant:function(e){return function(){var t=[].slice.call(arguments);return e.beta.assistants.del(t[0])}}(e),updateAssistant:function(e){return function(){var t=[].slice.call(arguments),n=t[0],r=t[1];return r.fileIds&&(r.file_ids=r.fileIds,delete r.fileIds),e.beta.assistants.update(n,r)}}(e),createThread:function(e){return function(){var t=[].slice.call(arguments)[0];return null==t&&(t={}),e.beta.threads.create(t)}}(e),getThread:function(e){return function(){var t=[].slice.call(arguments);return e.beta.threads.retrieve(t[0])}}(e),deleteThread:function(e){return function(){var t=[].slice.call(arguments);return e.beta.threads.del(t[0])}}(e),createMessage:function(e){return function(){var t=[].slice.call(arguments),n=t[0],r=t[3],s={role:t[1],content:t[2]};return null!=r&&(s=Object.assign(s,r)),e.beta.threads.messages.create(n,s)}}(e),listMessages:function(e){return function(){var t=[].slice.call(arguments);return e.beta.threads.messages.list(t[0],t[1])}}(e),uploadFile:function(e){return function(){var t=[].slice.call(arguments);return e.files.create({file:t[0],purpose:t[1]})}}(e),createAssistantFile:function(e){return function(){var t=[].slice.call(arguments);return e.beta.assistants.files.create(t[0],{file_id:t[1]})}}(e),createRun:function(e){return function(){var t=[].slice.call(arguments),n=t[1];return e.beta.threads.runs.create(t[0],{assistant_id:n.assistantId,additional_instructions:n.instructions,tools:null!=n.tools?n.tools:[]})}}(e),getRun:function(e){return function(){var t=[].slice.call(arguments);return e.beta.threads.runs.retrieve(t[0],t[1])}}(e),listRuns:function(e){return function(){var t=[].slice.call(arguments);return e.beta.threads.runs.list(t[0])}}(e),cancelRun:function(e){return function(){var t=[].slice.call(arguments);return e.beta.threads.runs.cancel(t[0],t[1])}}(e),submitToolOutputsToRun:function(e){return function(){var t=[].slice.call(arguments);return e.beta.threads.runs.submitToolOutputs(t[0],t[1],t[2])}}(e)}),n}var O=function(i){try{var a,l=i.credentials,u=l.key,c=l.endPoint;a="openai"===i.provider?new e({apiKey:u,dangerouslyAllowBrowser:!0}):new t(c,new n(u,{}));var p,O=function(e,t,n){var r=[A,T,j,k,_,w,S,x,N],s=[];r.forEach(function(e){var t={type:"function",function:Object.assign({},e)};s.push(t)});var o={_getData:m,_listSASObjects:y,_listSASTables:g,_listColumns:v,_listSASDataLib:b,_runSAS:h,_keywords:d,_describeTable:f,_catalogSearch:P},i="undefined"==typeof window?(console.log("instructions for node use "),"\n You are a Assistant designed for SAS users. You can help SAS users with their SAS related questions and provide information\n  on topics like libraries(alias of libs, caslibs and libref), reports  and tables. You can also fetch data from then tables and run SAS programs. You can also help answer questions about the \n  data that has been returned from previous queries. Most times the user will be focused on these areas.\n  Always try the provided tools first to find an answer to your question. If the query is not clear then ask the user for clarification before creating a response.\n  Always report always include annotation when information is found in a file.\n  "):(console.log("instructions for web"),"\n You are a Assistant designed for SAS users. You can help SAS users with their SAS related questions and provide information\n  on topics like libraries(alias of libs, caslibs and libref), reports  and tables. You can also fetch data from then tables and run SAS programs. You can also help answer questions about the \n  data that has been returned from previous queries. Most times the user will be focused on these areas. \n  try the provided tools and files first to find an answer to your question. If the query is not clear then ask the user for clarification before creating a response.\n  Always include annotation when information is found in a file\n  Here are some tips for formatting the response from the tools.\n  For example,\n\n  Format the response as a html table if the content of the response is one of the following schema:\n\n  - a comma-delimited format \n  - or of this schema [{a:1,b:2},{a:1,b:3},...]\n  - or of this schema{a: {a1:10, bx:20, c: {cx:3, az: 4}} }, {d: {d1:10, d2:20},...}\n\n  Below is an example of a  html table format with nested table\n\n      '<table>     \n         <tr>     \n           <th>Name</th>     \n           <th>Value</th>     \n         </tr>     \n         <tr>     \n           <td>a</td>     \n           <td>     \n             <table>     \n               <tr>     \n                 <th>Name</th>     \n                 <th>Value</th>     \n               </tr>     \n               <tr>     \n                 <td>a1</td>     \n                 <td>10</td>     \n               </tr>     \n               <tr>     \n                 <td>bx</td>     \n                 <td>20</td>     \n               </tr>     \n               <tr>     \n                 <td>c</td>     \n                 <td>     \n                   <table>     \n                     <tr>     \n                       <th>Name</th>     \n                       <th>Value</th>     \n                     </tr>     \n                     <tr>     \n                       <td>cx</td>     \n                       <td>3</td>     \n                     </tr>     \n                     <tr>     \n                       <td>az</td>     \n                       <td>4</td>     \n                     </tr>     \n                   </table>     \n                 </td>     \n               </tr>     \n             </table>     \n           </td>     \n         </tr>     \n         <tr>     \n           <td>d</td>     \n           <td>     \n             <table>     \n               <tr>     \n                 <th>Name</th>     \n                 <th>Value</th>     \n               </tr>     \n               <tr>     \n                 <td>d1</td>     \n                 <td>10</td>     \n               </tr>     \n               <tr>     \n                 <td>d2</td>     \n                 <td>20</td>     \n               </tr>     \n             </table>     \n           </td>     \n         </tr>     \n       </table>     \n     '\n\n  if the response from a tool is of the form  like ['a','b','c', ...] or [1,11,8, ...] then format it as  html unordered list element\n  Below is a sample html unordered list format.\n  '<ul>\n    <li>a</li>\n    <li>b</li>\n    <li>3</li>\n  </ul>'\n\n  if the response from a tool is of the form {a:1,b:2} then format it as  html table with a single column.\n  '<table>\n  <tr>\n  <th>Name</th>\n  <th>Value</th>\n  </tr>\n    <tr>\n      <td>a</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <td>b</td>\n      <td>1</td>\n    </tr>\n\n  </table>'\n\n  The suggested styling for the html table is as follows:\n    The html table should have a light blue background for the column headers.\n    Use a border width of 1px and solid style for the table.\n");return{specs:r,tools:s,functionList:o,instructions:i}}(),q=[],I=i.domainTools.tools;q=I.length>0?O.tools.filter(function(e){var t=I.findIndex(function(t,n){return t.function.name===e.function.name});return-1!==t&&console.log("overriding",e.function.name),-1===t}):O.tools,p=!0===i.domainTools.replace?i.domainTools:{tools:q.concat(I),functionList:Object.assign(O.functionList,i.domainTools.functionList),instructions:i.instructions?i.instructions+O.instructions:O.instructions},i.code&&p.tools.push({type:"code_interpreter"}),i.retrieval&&p.tools.push({type:"retrieval"});var R={provider:i.provider,model:i.model,domainTools:p,instructions:p.instructions,assistantName:i.assistantName,assistant:null,assistantid:i.assistantid,thread:null,threadid:i.threadid,appEnv:null,client:a,run:null,assistantApi:E(a,i.provider),code:i.code,retrieval:i.retrieval,userData:i.userData,user:i.user};return Promise.resolve(function(e){try{var t={host:null,logonPayload:null,store:null,source:"none",currentSource:"none",session:null,servers:null,serverName:null,casServerName:null,sessionID:null,compute:{},cas:{},restaf:r,restaflib:s,restafedit:o};if(null==e)return Promise.resolve(t);if("none"==e.source)return t.userData=e.userData,t.logonPayload=e.logonPayload,t.currentSource="none",Promise.resolve(t);var n=e.source,i=e.logonPayload,a=n.split(",")[0];t.currentSource=a,t.host=i.host;var l=r.initStore({casProxy:!0});return Promise.resolve(l.logon(i)).then(function(){function e(){var e=function(){if(n.indexOf("compute")>=0){t.compute={servers:null};var e=function(e,n){try{var r=Promise.resolve(s.computeSetup(l)).then(function(e){return Promise.resolve(l.apiCall(t.session.links("self"))).then(function(n){t.compute.sessionID=n.items("id"),"compute"===a&&(t.source="compute",t.session=e,t.servers=null,t.serverName=null,t.sessionID=t.compute.sessionID)})})}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}(0,function(e){console.log(JSON.stringify(e,null,4))});if(e&&e.then)return e.then(function(){})}}();return e&&e.then?e.then(function(){return t}):t}t.host=i.host,t.logonPayload=i,t.store=l;var r=function(){if(n.indexOf("cas")>=0)return Promise.resolve(s.casSetup(l,null)).then(function(e){var n=e.session,r=e.servers,s=n.links("execute","link","server");return t.cas={session:n,servers:r,casServerName:s},Promise.resolve(l.apiCall(n.links("self"))).then(function(e){t.cas.sessionID=e.items("id"),"cas"===a&&(t.source="cas",t.session=n,t.servers=r,t.serverName=s,t.casServerName=s,t.sessionID=t.cas.sessionID)})})}();return r&&r.then?r.then(e):e()})}catch(e){return Promise.reject(e)}}(i.viyaConfig)).then(function(e){return R.appEnv=e,R.appEnv.userData=i.userData,R.appEnv.user=i.user,Promise.resolve(function(e){try{var t,n=e.assistantName,r=e.model,s=e.assistantid,o=e.instructions,i=e.domainTools,a=e.assistantApi;return Promise.resolve(function(e,l){try{var u=function(){function e(e){if(t)return e;var l={name:n,instructions:o,model:r,tools:i.tools};console.log("Attempting to find assistant by name ",n);var u=null;return Promise.resolve(a.listAssistants({order:"desc",limit:"100"})).then(function(e){function t(){return console.log("Creating new assistant"),Promise.resolve(a.createAssistant(l)).then(function(e){return u=e})}if(null!=(u=e.data.find(function(e){if(e.name===n)return e}))&&"REUSE"===s)return console.log("Found assistant ",n,u.id),u;var r=function(){if(null!=u)return console.log("Deleting old assistant ",n,u.id),Promise.resolve(a.deleteAssistant(u.id)).then(function(){})}();return r&&r.then?r.then(t):t()})}var l=function(){if("NEW"!==s&&"REUSE"!==s)return console.log("Using assistantid ",s),Promise.resolve(a.getAssistant(s)).then(function(e){return t=1,e})}();return l&&l.then?l.then(e):e(l)}()}catch(e){return l(e)}return u&&u.then?u.then(void 0,l):u}(0,function(e){throw console.log(e),new Error("Error status "+e.status+". Failed to create assistant. See console for details.")}))}catch(e){return Promise.reject(e)}}(R)).then(function(e){return R.assistant=e,Promise.resolve(function(e){try{var t,n=e.assistantApi,r=null,s=e.threadid,o=e.assistant.metadata.lastThread,i=function(e,i){try{var a=function(){function e(e){var i;if(t)return e;function a(e){if(i)return e;function t(){return console.log("Creating new thread"),Promise.resolve(n.createThread()).then(function(e){return r=e})}var s=function(){if(null!=o)return console.log("Deleting last thread",o),Promise.resolve(n.deleteThread(o)).then(function(){})}();return s&&s.then?s.then(t):t()}var l=function(){if("REUSE"===s&&null!=o)return console.log("Attempting to use previous ",o),Promise.resolve(n.getThread(o)).then(function(e){return i=1,e})}();return l&&l.then?l.then(a):a(l)}var i=function(){if("REUSE"!==s&&"NEW"!==s)return console.log("Using threadid ",s),Promise.resolve(n.getThread(s)).then(function(e){return t=1,e})}();return i&&i.then?i.then(e):e(i)}()}catch(e){return i(e)}return a&&a.then?a.then(void 0,i):a}(0,function(e){throw console.log(e),new Error("Error status "+e.status+". Failed to create thread. See console for details.")});return Promise.resolve(i&&i.then?i.then(function(){return r}):r)}catch(e){return Promise.reject(e)}}(R)).then(function(e){return R.thread=e,Promise.resolve(R.assistantApi.updateAssistant(R.assistant.id,{metadata:{lastThread:R.thread.id}})).then(function(e){return R.assistant=e,R.threadid=R.thread.id,console.log("--------------------------------------"),console.log("Current session:"),console.log("Provider: ",R.provider),console.log("Model: ",R.model),console.log("Assistant: ",R.assistant.name,"Assistant id",R.assistant.id),console.log("Threadid: ",R.thread.id),console.log("Viya Source:",R.appEnv.source),console.log("--------------------------------------"),R})})})})}catch(e){return Promise.reject(e)}},q=function(e,t){try{return Promise.resolve(e.assistantApi.listMessages(e.thread.id,{limit:t})).then(function(e){for(var t=[],n=e.data,r=0;r<e.data.length;r++){var s=n[r].content[0];if("assistant"!==n[r].role)break;console.log("annotations",s[s.type].annotations),t.push({id:n[r].id,role:n[r].role,type:s.type,content:s[s.type].value})}return t.length>1&&(t=t.reverse()),t})}catch(e){return Promise.reject(e)}};function I(e,t,n){if(!e.s){if(n instanceof D){if(!n.s)return void(n.o=I.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(I.bind(null,e,t),I.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var R=function(e,t){try{var n=t.assistantApi,r=t.thread,s=null,o=null,i=function(e,t){var n;do{var r=e();if(r&&r.then){if(!F(r)){n=!0;break}r=r.v}var s=t();if(F(s)&&(s=s.v),!s)return r}while(!s.then);var o=new D,i=I.bind(null,o,2);return(n?r.then(a):s.then(l)).then(void 0,i),o;function a(n){for(r=n;F(s=t())&&(s=s.v),s;){if(s.then)return void s.then(l).then(void 0,i);if((r=e())&&r.then){if(!F(r))return void r.then(a).then(void 0,i);r=r.v}}I(o,1,r)}function l(n){if(n){do{if((r=e())&&r.then){if(!F(r))return void r.then(a).then(void 0,i);r=r.v}if(F(n=t())&&(n=n.v),!n)return void I(o,1,r)}while(!n.then);n.then(l).then(void 0,i)}else I(o,1,r)}}(function(){return Promise.resolve(n.getRun(r.id,e.id)).then(function(e){o=e,console.log("-------------------",o.status);var t=function(){if("queued"===o.status||"in_progress"===o.status||"cancelling"===o.status)return Promise.resolve(new Promise(function(e){return setTimeout(e,500)})).then(function(){console.log("waited 2000 ms")});s=o.status}();if(t&&t.then)return t.then(function(){})})},function(){return null===s});return Promise.resolve(i&&i.then?i.then(function(){return o}):o)}catch(e){return Promise.reject(e)}};const D=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,s=this.s;if(s){const e=1&s?t:n;if(e){try{I(r,1,e(this.v))}catch(e){I(r,2,e)}return r}return this}return this.o=function(e){try{const s=e.v;1&e.s?I(r,1,t?t(s):s):n?I(r,1,n(s)):I(r,2,s)}catch(e){I(r,2,e)}},r},e}();function F(e){return e instanceof D&&1&e.s}const C="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function J(e,t,n){if(!e.s){if(n instanceof L){if(!n.s)return void(n.o=J.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(J.bind(null,e,t),J.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var L=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,s=this.s;if(s){var o=1&s?t:n;if(o){try{J(r,1,o(this.v))}catch(e){J(r,2,e)}return r}return this}return this.o=function(e){try{var s=e.v;1&e.s?J(r,1,t?t(s):s):n?J(r,1,n(s)):J(r,2,s)}catch(e){J(r,2,e)}},r},e}();function U(e){return e instanceof L&&1&e.s}function M(e,t,n){return"openai"===n?{tool_call_id:e,output:JSON.stringify(t)}:{toolCallId:e,output:JSON.stringify(t)}}var Y=function(e,t,n){try{var r=function(t){return Promise.resolve(function(e,t,n){try{var r=e.assistant;return Promise.resolve(e.assistantApi.createRun(e.thread.id,{assistantId:r.id,instructions:n,tools:r.tools})).then(function(t){return e.run=t,Promise.resolve(R(t,e)).then(function(t){var n,r=function(){if("completed"===t.status)return Promise.resolve(q(e,5)).then(function(e){n=e});var r=function(){if("requires_action"===t.status)return Promise.resolve(function(e,t){try{var n=function(){return Promise.resolve(r.submitToolOutputsToRun(i.id,a.id,"openai"===o?{tool_outputs:u}:u)).then(function(e){return Promise.resolve(R(e,t))})},r=t.assistantApi,s=t.appEnv,o=t.provider,i=t.thread,a=t.run,l=t.domainTools.functionList,u=[],c=function(e,t,n){if("function"==typeof e[C]){var r,s,o,i=e[C]();if(function e(n){try{for(;!(r=i.next()).done;)if((n=t(r.value))&&n.then){if(!U(n))return void n.then(e,o||(o=J.bind(null,s=new L,2)));n=n.v}s?J(s,1,n):s=n}catch(e){J(s||(s=new L),2,e)}}(),i.return){var a=function(e){try{r.done||i.return()}catch(e){}return e};if(s&&s.then)return s.then(a,function(e){throw a(e)});a()}return s}if(!("length"in e))throw new TypeError("Object is not iterable");for(var l=[],u=0;u<e.length;u++)l.push(e[u]);return function(e,t,n){var r,s,o=-1;return function n(i){try{for(;++o<e.length;)if((i=t(o))&&i.then){if(!U(i))return void i.then(n,s||(s=J.bind(null,r=new L,2)));i=i.v}r?J(r,1,i):r=i}catch(e){J(r||(r=new L),2,e)}}(),r}(l,function(e){return t(l[e])})}("openai"===o?e.required_action.submit_tool_outputs.tool_calls:e.requiredAction.submitToolOutputs.toolCalls,function(e){var n=e.function.name;console.log("Requested function: ",n);var r=JSON.parse(e.function.arguments);console.log("Parameters: ",r);var i=l[n],a=function(){if(null==i)u.push(M(e.id,"Function "+n+" not found. \n      Probable causes: \n        Using thread that had outdated tool references.\n        Currrent specs point has mistmatch with function name\n        ",o));else{var a=function(i,a){try{var c=Promise.resolve(l[n](r,s,t)).then(function(t){console.log(">> Function call "+n+" completed"),u.push("openai"===o?{tool_call_id:e.id,output:JSON.stringify(t)}:{toolCallId:e.id,output:JSON.stringify(t)})})}catch(e){return a(e)}return c&&c.then?c.then(void 0,a):c}(0,function(t){u.push(M(e.id,t,o))});if(a&&a.then)return a.then(function(){})}}();if(a&&a.then)return a.then(function(){})});return Promise.resolve(c&&c.then?c.then(n):n())}catch(e){return Promise.reject(e)}}(t,e)).then(function(t){return console.log("getting latest message "),Promise.resolve(q(e,5)).then(function(e){n=e})});n=[{runStatus:t.status}]}();return r&&r.then?r.then(function(){}):void 0}();return r&&r.then?r.then(function(){return n}):n})})}catch(e){return Promise.reject(e)}}(e,0,n))},s=e.thread,o=e.assistantApi,i=function(n,r){try{var i=(a={},"openai"===e.provider?a.file_ids=e.assistant.file_ids:a.fileIds=e.assistant.fileIds,Promise.resolve(o.createMessage(s.id,"user",t,a)).then(function(){}))}catch(e){return r(e)}var a;return i&&i.then?i.then(void 0,r):i}(0,function(e){throw console.log(e.status),console.log(e.error),new Error("\n     Request failed on adding user message to thread.\n     See error below. \n     If thread is active, you can try canceling the run.\n     "+e.status+" "+e.error)});return Promise.resolve(i&&i.then?i.then(r):r())}catch(e){return Promise.reject(e)}};function V(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var z=function(e,t){try{var n,r=function(t){return n?t:V(function(){if(null!=o.metadata.lastThread)return Promise.resolve(s.deleteThread(o.metadata.lastThread)).then(function(t){return console.log("Thread ${assistant.metadata.lastThread} deleted",t),Promise.resolve(s.deleteAssistant(o.id)).then(function(n){return t=n,console.log("Assistant "+o.name+" deleted",t),e.assistant=null,e.assistantid="0","Assistant "+o.name+" deleted"})})},function(e){throw console.log(e),new Error("Failed to delete session and thread\n    "+e)})},s=e.assistantApi,o=e.assistant,i=function(){if(null!=t)return V(function(){if(null!=t)return Promise.resolve(s.deleteAssistant(id)).then(function(){return n=1,"Assistant "+t+" deleted."})},function(e){throw console.log(e),new Error("\n        Delete of assistant "+t+" failed")})}();return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(e){return Promise.reject(e)}},B=function(e,t){try{return Promise.resolve(e.assistantApi.listMessages(e.thread.id,{limit:t})).then(function(e){return e.data.map(function(e){var t=e.content[0];return{id:e.id,role:e.role,type:t.type,content:t[t.type].value}})})}catch(e){return Promise.reject(e)}};function G(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var W=function(e,t,n,r,s){try{var o=s.assistantApi,i=s.assistant,a=s.provider,l=null;return Promise.resolve(G(function(){return Promise.resolve("openai"===a?o.uploadFile(t,r):o.uploadFile(n,r,{filename:e})).then(function(t){return l=t,console.log("uploaded file:",l.id),Promise.resolve(o.createAssistantFile(i.id,l.id)).then(function(t){return console.log("Assistant File ",t.id),Promise.resolve(function(e,t){try{var n=e.assistantApi,r=e.assistant,s="openai"===e.provider?r.file_ids:r.fileIds;return s.push(t.id),s=s.filter(function(e){return null!=e}),Promise.resolve(G(function(){return Promise.resolve(n.updateAssistant(r.id,{fileIds:s})).then(function(t){e.assistant=t})},function(e){throw console.log(e),new Error("Failed to update assistant with new file "+t.id)}))}catch(e){return Promise.reject(e)}}(s,t)).then(function(){return{fileName:e,fileId:l.id,assistantFileId:t.id}})})})},function(t){throw console.log(t),new Error("Failed to upload file "+e)}))}catch(e){return Promise.reject(e)}};function H(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var K=function(e,t,n){try{var r,s=function(e){return r?e:null==l||null==a?"No run or thread to cancel":H(function(){return Promise.resolve(o.getRun(a.id,l.id)).then(function(e){return null!==e.completed||"cancelling"===e.status?"Run "+l.id+" status: "+e.status+" , completed: "+e.completed:Promise.resolve(o.cancelRun(a.id,l.id))})},function(){throw new Error("\n    Cancel run failed.  \n    Best action is to simply wait for a while for it to timeout \n    The last alternative is to delete the Assistant "+i.name+" and restart your session")})},o=e.assistantApi,i=e.assistant,a=e.thread,l=e.run,u=function(){if(null!=t&&null!=n)return H(function(){return console.log("Cancelling run",t,n),Promise.resolve(o.cancelRun(t,n)).then(function(e){return r=1,e})},function(e){throw n})}();return Promise.resolve(u&&u.then?u.then(s):s(u))}catch(e){return Promise.reject(e)}};export{K as cancelRun,z as deleteAssistant,q as getLatestMessage,B as getMessages,Y as runAssistant,O as setupAssistant,W as uploadFile};
//# sourceMappingURL=index.module.js.map
