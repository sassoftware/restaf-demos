<!--
  ~ /* ------------------------------------------------------------------------------------
  ~  * Copyright (c) SAS Institute Inc.
  ~  *  Licensed under the Apache License, Version 2.0 (the "License");
  ~  * you may not use this file except in compliance with the License.
  ~  * You may obtain a copy of the License at
  ~  *
  ~  * http://www.apache.org/licenses/LICENSE-2.0
  ~  *
  ~  *  Unless required by applicable law or agreed to in writing, software
  ~  * distributed under the License is distributed on an "AS IS" BASIS,
  ~  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  * See the License for the specific language governing permissions and
  ~ * limitations under the License.
  ~ ----------------------------------------------------------------------------------------*/
  ~
  -->

<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">

        <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0/polyfill.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
     
        <style>
            .container {
                display: flex;
                flex-direction: column;
                flex-wrap: nowrap;
                min-height: 800px;
            }

            .elabel {
                display: inline-block;

                clear: left;
                width: 250px;
                text-align: right;
            }

            .einput {
                display: inline-block;

            }

            .div1 {
                border: 1px solid black;
                background: lightskyblue;

            }

            .div2 {
                border: 1px solid black;
                background: lightskyblue;
                height: 200px;
            }

            table {
                border-collapse: collapse;
                border-spacing: 0;
                width: 100%;
                border: 1px solid #ddd;
            }

            th,
            td {
                text-align: left;
                padding: 16px;
            }

            tr:nth-child(even) {
                background-color: #f2f2f2
            }
        </style>

        <script type="text/babel">
            function  Table(props) {
                let {data, onCellEdit, title, edit , err } = props;
                debugger;
                let thead = <thead>
                    <tr>
                        <th style={{backgroundColor: 'lightgrey'}} colspan={2} scope="col"> {title} </th>
                    </tr>
                </thead>
                    debugger;

                let tbody = <tbody>
                    {data.map((row, index) => {
                        /* Nathaniel */
                        let name = (index === err) ? row.label + '*' : row.label;
                        let v = (edit === true ) ? <input type="text" value={row.value} onChange={e => onCellEdit(index, e.target.value)} /> 
                                                : <input type="text"  disabled value={row.value}/>
                        return (
                            <tr scope="row">
                                <td> {name} </td>
                                <td> {v} </td>
                            </tr>
                        )
                    })}
                    </tbody>;
                    

                return (
                    <div>
                    <table class="table table-striped">
                        {thead}
                        {tbody}
                    </table>
                    </div>
                )
            }

            class TableViewer extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {
                        data      : props.data,
                        runOnScore: props.runOnScore,
                        title     : props.title,
                        edit      : props.edit,
                        err       : -1
                    };
                }
                componentWillReceiveProps(nextProps) {
                    this.setState({data: nextProps.data, oncellChange: nextProps.onCellChange, title: nextProps.title, edit: nextProps.edit });
                }
                _onCellEdit = (index, value) => {
                    let data = this.state.data;
                    let err = -1;
                    let row = data[index];
                    if ( row.RawType === 'Num' && isNaN(value) === true) {
                        err = index;
                    }
                    data[index].value = value;
                    this.setState({data: data, err: err});
                }
                _buttonClick = () => {      
                    if ( this.state.err === -1 ){
                    this.state.runOnScore(this.state.data);
                    }
                }
                render() {
                    return (
                        <div>
                        <Table data={this.state.data} onCellEdit={this._onCellEdit} title={this.state.title} edit={this.state.edit} err={this.state.err} />
                        {(this.state.edit === true && this.state.data.length > 0) ? <button onClick={this._buttonClick} > Score Now </button> : null}
                        </div>
                    );
                }
            }
            function tableViewer (data, runOnScore, title, container, edit) {
                ReactDOM.render(<TableViewer data={data} runOnScore={runOnScore} title={title} edit={edit}/>,
                    document.querySelector(container));
                return true;
                }

  
  </script>

        <script>

            debugger;
            let host;
            let astore;
            let displayColumns = {};
            let userValues = {};
            let runOnScoreb;
            /* Nathaniel */
            let ascoreLabels = {
                'paysimsvdd.sasast': {
                    _Index_        : 'Row No',
                     type_n        : 'Type',
                     amount        : 'Loan Amount',
                     newbalanceDest: 'Final new Balance',
                     newbalanceOrig: 'New original Balance',
                     oldbalanceDest: 'Old Balance',
                     oldbalanceOrg : 'Old Original Balance',
                     isFraud       : 'Are you a fraud',
                     _SVDDDISTANCE_: "Scoring Distance",
                     _SVDDSCORE_   : "Score"
                    }
            }

            function setup() {
                runOnScoreb = runOnScore.bind(this);
                let href = window.location.href;
                let n = href.lastIndexOf('/app');
                host = href.substring(0, n);
                console.log(host);
                document.getElementById("host").value = host;
            }

            function setup2() {
                loadAstore()
                    .then(results => {
                        let temp = [ { Name: 'Waiting...', RawType: 'Num', value: '' } ];
                        tableViewer(results, runOnScoreb, 'Enter Values', '#userInput', true);
                        tableViewer(temp, runOnScoreb, 'Your scores', '#output', false);
                    })
                    .catch(err => alert(err));
            }

            async function loadAstore() {
                debugger;
                astore = {
                    caslib: document.getElementById('caslib').value,
                    name: document.getElementById('astore').value
                }
                let config = {
                    url: host + '/describe',
                    method: 'POST',
                    data: {
                        astore: astore
                    }
                }
                let apiKey = document.getElementById('apikey').value;
                if ( apiKey.length > 0 ) {
                    config.headers = { 'x-api-key': `${apiKey}`}
                }
                let r = await axios(config);
                /* Nathaniel */
                let labels = ascoreLabels[document.getElementById('astore').value];
                displayColumns = r.data.columns.map(r => {
                    r.label = (labels != null) ? labels[r.Name] : r.Name
                    r.value = '';
                    return r;
                })

                return displayColumns;

            }
            function runOnScore(data) {
                runScore(data)
                    .then(results => tableViewer(results, runOnScoreb, 'Recommendations', '#output', false))
                    .catch(err => alert(err))
            }

            async function runScore(data) {
                userValues = {};
                for (let i = 0; i < data.length; i++) {
                    let r = data[ i ];
                    userValues[ r.Name ] = parseFloat(r.value);
                };
                debugger;
                let payload = {
                    astore: {
                        caslib: document.getElementById('caslib').value,
                        name: document.getElementById('astore').value
                    },
                    input: userValues
                }

                let config = {
                    url: host + '/score',
                    method: 'POST',
                    data: payload
                }
                let apiKey = document.getElementById('apikey').value;
                if ( apiKey.length > 0 ) {
                    config.headers = { 'x-api-key': `${apiKey}`}
                }
                console.log(config);
                debugger;
                let r = await axios(config);
                let t = [];
                let userValuesKeys = Object.keys(userValues);
                /* Nathaniel */
                let labels = ascoreLabels[document.getElementById('astore').value];
                for (let key in r.data.score) {
                    if (userValuesKeys.indexOf(key) === -1) {
                        r1 = { 
                            Name: key,
                            value: r.data.score[ key ],
                            label: (labels != null) ? labels[key] : key
                        };
                            t.push(r1);
                    }
                }
                return t;
            }


        </script>
    </head>

    <body onload="setup()">
        <div>
            <form action="">
                <label class="elabel" for="host">Serverless host</label>
                <input class="einput" type="text" id="host" disabled size="50">
                <br>
                <label class="elabel" for="caslib">caslib </label>
                <input class="einput" type="text" value="casuser" id="caslib" size="50">
                <br>
                <label class="elabel" for="astore">astore </label>
                <input class="einput" type="text" id="astore" value="paysimsvdd.sasast" size="50">
                <br>
                <label class="elabel" for="apikey">apiKey </label>
                <input class="einput" type="password" id="apikey"  size="72">
                <br>
                
            </form>
            <button onclick="setup2()"> Load </button>
        </div>
    
        </div>
        <br>
    
        <br>
        <div id="userInput"> </div>
        <br>
        <br>
        <div id="output"> </div>
    </body>

</html>